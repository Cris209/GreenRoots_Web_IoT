<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Green Roots</title>
    
    <link rel="stylesheet" href="/home.css"> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* CSS adicional para asegurar que el mapa se renderice correctamente */
        #mapContainer {
            height: 400px; /* Altura crucial para Leaflet */
            width: 100%;
        }
    </style>
    
    <script>
        // Funci√≥n de Protecci√≥n de Ruta (Solo permite 'Administrador' con May√∫scula Inicial)
        function protectRoute(allowedRoles) {
            const userDataJSON = localStorage.getItem("usuario");
            const loginPage = "login.html";
            const homePage = "index.html"; 

            if (!userDataJSON) {
                // No hay sesi√≥n
                window.location.replace(loginPage);
                return false;
            }

            const userData = JSON.parse(userDataJSON);
            // Obtenemos el rol con la May√∫scula Inicial de Firestore (ej: 'Administrador')
            const userRol = userData.rol?.trim(); 

            // Check if the user's role (case-insensitive) matches any allowed role
            const userRolLower = userRol?.toLowerCase();
            const allowedRolesLower = allowedRoles.map(r => r.toLowerCase());
            
            if (!userRol || !allowedRolesLower.includes(userRolLower)) {
                // Sesi√≥n, pero rol incorrecto
                alert("Acceso denegado. Solo el rol Administrador tiene acceso a este panel.");
                window.location.replace(homePage);
                return false;
            }
            return true;
        }

        // üö® Llama a la funci√≥n de protecci√≥n: Solo 'Administrador'
        const isAllowed = protectRoute(['Administrador']);
        
        if (!isAllowed) {
            // Detiene la carga del script si no est√° permitido
            throw new Error("Acceso no autorizado. Redirecci√≥n en curso."); 
        }
    </script>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <img src="/Green_Roots.jpg" alt="Green Roots Logo" class="logo-img">
                    <h1>Administrador</h1>
                </div>
                <div class="auth-buttons" style="display: flex; gap: 10px;">
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                    <a id="logoutBtn" href="#" class="nav-link logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
                </div>
            </div>
        </nav>
    </header>
    
    <main style="padding-top: 100px; padding-bottom: 40px;">
        <div class="container">
            <h2 class="section-title">Gesti√≥n Central y Validaci√≥n de Datos ‚öôÔ∏è</h2>

            <div class="info-grid">
                <section class="card validation-queue info-card warning">
                    <div class="card-icon" style="background: var(--warning-orange);"><i class="fas fa-check-double"></i></div>
                    <h3>Registros Pendientes de Validaci√≥n (<span id="validationCount">0</span>)</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Asegure la trazabilidad y transparencia del impacto.</p>
                    <button id="refreshBtn" class="submit-btn" style="width: 100%; background: var(--primary-green); margin-bottom: 10px;">
                        <i class="fas fa-sync-alt"></i> Actualizar Lista
                    </button>
                    <button id="diagnosticBtn" class="submit-btn" style="width: 100%; background: var(--warning-orange); margin-bottom: 10px;">
                        <i class="fas fa-search"></i> Diagnosticar Base de Datos
                    </button>
                    <ul id="registrosPendientes" style="list-style: none; padding-left: 0;">
                        <li><i class="fas fa-spinner fa-spin"></i> Cargando registros...</li>
                    </ul>
                    <p id="noPending" style="text-align: center; color: var(--success-green); font-weight: 600; display: none;">‚úÖ ¬°No hay registros pendientes!</p>
                </section>

                <section class="card management-tools info-card">
                    <div class="card-icon"><i class="fas fa-tasks"></i></div>
                    <h3>Gesti√≥n de Eventos</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Crea y gestiona eventos para voluntarios.</p>
                    <button id="showEventosBtn" class="submit-btn" style="background: var(--light-green); margin-bottom: 10px;">
                        <i class="fas fa-bullhorn"></i> Ver Eventos
                    </button>
                    <button id="createEventoBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 10px;">
                        <i class="fas fa-plus"></i> Crear Nuevo Evento
                    </button>
                    <button id="loadUsersBtnAlt" class="submit-btn" style="background: var(--forest-green); margin-bottom: 10px;">
                        <i class="fas fa-users-cog"></i> Gestionar Usuarios
                    </button>
                </section>
            </div>

            <section class="card user-management-card" style="margin-top: 40px; padding: 30px; display: none;" id="userManagementSection">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios</h3>
                <button id="loadUsersBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 15px;">
                    <i class="fas fa-sync-alt"></i> Cargar Usuarios
                </button>
                <div id="usersList" style="max-height: 500px; overflow-y: auto;">
                    </div>
            </section>

            <section class="card event-management-card" style="margin-top: 40px; padding: 30px; display: none;" id="eventoManagementSection">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-calendar"></i> Gesti√≥n de Eventos</h3>
                <div id="eventoList" style="margin-bottom: 20px;">
                    </div>
            </section>

            <div id="createEventoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Crear Nuevo Evento</h3>
                    <form id="createEventoForm">
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Nombre del Evento *</label>
                            <input type="text" id="eventoTitulo" required placeholder="Ej: Jornada de Reforestaci√≥n Zona Norte">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Descripci√≥n *</label>
                            <textarea id="eventoDescripcion" required rows="3" placeholder="Describe el evento..."></textarea>
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Fecha del Evento</label>
                            <input type="date" id="eventoFecha" required>
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Hora del Evento</label>
                            <input type="time" id="eventoHora">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Ubicaci√≥n</label>
                            <input type="text" id="eventoUbicacion" placeholder="Ej: Parque Central">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Estado</label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="eventoActivo" checked style="width: auto;">
                                <span>Evento Activo</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="submit-btn" style="background: var(--primary-green); flex: 1;">
                                <i class="fas fa-save"></i> Crear
                            </button>
                            <button type="button" class="submit-btn" id="closeEventoModal" style="background: var(--danger-red); flex: 1;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <section class="card impact-charts" style="margin-top: 40px; padding: 30px;">
                <h4 class="activity-title"><i class="fas fa-satellite-dish"></i> Monitoreo en Tiempo Real y Visualizaci√≥n de Impacto</h4>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-tint" style="color: var(--primary-green);"></i>
                        <p style="margin: 5px 0 0 0;">Humedad (%)</p>
                        <strong id="humedad-sensor" style="font-size: 1.5em; color: var(--primary-green);">--</strong>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-map-pin" style="color: #6c757d;"></i>
                        <p style="margin: 5px 0 0 0;">Latitud</p>
                        <strong id="latitud-sensor" style="font-size: 1.1em;">--</strong>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-map-pin" style="color: #6c757d;"></i>
                        <p style="margin: 5px 0 0 0;">Longitud</p>
                        <strong id="longitud-sensor" style="font-size: 1.1em;">--</strong>
                    </div>
                </div>

                <div id="graficoEspecies" style="margin-bottom: 20px;">
                    <div id="mapContainer" style="height: 400px; width: 100%; border-radius: 10px; margin-bottom: 15px; z-index: 1;">
                        </div>
                </div>
                
                <p style="text-align: center; color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                    Estado de Conexi√≥n RTDB: <span id="estado-firebase">Inicializando...</span> | 
                    √öltima Actualizaci√≥n: <span id="ultima-actualizacion">N/A</span>
                </p>

                <p style="text-align: center; color: var(--text-light);"><i class="fas fa-filter"></i> **Filtros:** Comunidad, Especie, Zona Geogr√°fica, Rol (Aqu√≠ ir√≠an los dem√°s gr√°ficos de impacto)</p>
            </section>
            
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Green Roots. Panel de Administrador.</p>
            </div>
        </div>
    </footer>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // La URL de tu Backend desplegado (Ajusta esto a tu URL real de Render)
        const API_URL = "https://greenroots-web.onrender.com/api"; 
        
        // Obtener datos del usuario (el rol se almacena como 'Administrador')
        const userData = localStorage.getItem("usuario") ? JSON.parse(localStorage.getItem("usuario")) : {};
        
        const listaRegistros = document.getElementById('registrosPendientes');
        const contadorElemento = document.getElementById('validationCount');
        const noPendingMessage = document.getElementById('noPending');
        // ==========================================================
        // ‚úÖ SOLUCI√ìN: FUNCI√ìN CENTRAL PARA OBTENER LOS HEADERS
        // ==========================================================
        /**
         * Genera los headers de autenticaci√≥n (Authorization y X-User-Rol)
         * Se asume que el token est√° en userData.token.
         * @returns {Object} Headers object for fetch requests.
         * @throws {Error} Si el token no est√° disponible.
         */
        function getAuthHeaders() {
            // El objeto userData ya fue cargado al inicio del script.
            const userToken = userData.token; 
            
            if (!userToken) {
                console.error("Token de autenticaci√≥n no encontrado en userData. Se requiere iniciar sesi√≥n.");
                // Opcional: podr√≠as redirigir a login.html aqu√≠.
                return {}; // Retorna un objeto vac√≠o para que fetch falle con 401
            }

            return {
                'Content-Type': 'application/json',
                // Env√≠a el token en el formato est√°ndar Bearer
                'Authorization': `Bearer ${userToken}`, 
                'X-User-Rol': userData.rol || 'Administrador' 
            };
        }


       
        // ===============================================
        // NUEVO: Variables Globales para Firebase/Mapa
        // ===============================================
        let firebaseApp; 
        let db; 
        let map; // Variable global para la instancia del mapa
        let currentMarker = null; // Variable para el marcador del sensor
        
        // Coordenadas predeterminadas (ejemplo: Chelsea, MA)
        const DEFAULT_LAT = 42.3936888;
        const DEFAULT_LON = -71.0412802;
        
        // ===============================================
        // NUEVO: 1. FUNCIONES DE FIREBASE Y LEAFLET
        // ===============================================

        /**
         * Inicializa el mapa Leaflet en el contenedor 'mapContainer'.
         */
        function initializeMap() {
            // L.map() ahora estar√° definido porque leaflet.js se carga primero.
            map = L.map('mapContainer').setView([DEFAULT_LAT, DEFAULT_LON], 13);

            // A√±ade la capa de tiles (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            console.log("‚úÖ Mapa Leaflet inicializado con √©xito.");
        }


        /**
         * Obtiene la configuraci√≥n de la API, inicializa el SDK de Firebase 
         */
        async function initializeFirebase() {
            const estadoElement = document.getElementById('estado-firebase');

            if (!userData) {
                estadoElement.textContent = "Usuario no autenticado.";
                return false;
            }

            try {
                estadoElement.textContent = "Obteniendo configuraci√≥n...";
                
                // Usamos una configuraci√≥n est√°tica para la demo
                const firebaseConfig = {
                    databaseURL: "https://greenroot-6dbfe-default-rtdb.firebaseio.com/"
                };
                
                // 2. INICIALIZACI√ìN DE FIREBASE CORE
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.database(); 
                
                estadoElement.textContent = "Conectado al RTDB.";
                console.log("‚úÖ Conexi√≥n de Firebase inicializada con √©xito.");
                
                return true;
                
            } catch (error) { 
                console.error("‚ùå Fallo al inicializar Firebase:", error);
                estadoElement.textContent = `ERROR: ${error.message.split(":")[0] || "No se pudo conectar"}`;
                return false;
            }
        }
        
        /**
         * Monitorea datos del nodo /greenroots en tiempo real (Realtime Database)
         * y actualiza el mapa.
         */
        function loadSensorData() {
            if (!db) {
                console.warn("No se puede iniciar el monitoreo: Firebase DB no est√° inicializada.");
                return;
            }

            // Referencia al nodo principal de datos '/greenroots'
            const greenrootsRef = db.ref('greenroots'); 
            
            // Elementos del DOM a actualizar
            const humElement = document.getElementById('humedad-sensor');
            const latElement = document.getElementById('latitud-sensor');
            const lonElement = document.getElementById('longitud-sensor');
            const estadoElement = document.getElementById('estado-firebase');
            const ultimaActElement = document.getElementById('ultima-actualizacion');
            
            greenrootsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // 1. Actualizar los valores en el panel
                    const humedad = data.humedad !== undefined ? parseFloat(data.humedad).toFixed(1) : '--';
                    const latitud = data.latitud !== undefined ? parseFloat(data.latitud) : null;
                    const longitud = data.longitud !== undefined ? parseFloat(data.longitud) : null;

                    humElement.textContent = humedad;
                    latElement.textContent = latitud !== null ? latitud.toFixed(6) : '--';
                    lonElement.textContent = longitud !== null ? longitud.toFixed(6) : '--';

                    // 2. Actualizar el marcador en el mapa
                    if (map && latitud !== null && longitud !== null) {
                        const newLatLng = new L.LatLng(latitud, longitud);

                        if (currentMarker) {
                            // Mueve el marcador existente a la nueva posici√≥n
                            currentMarker.setLatLng(newLatLng);
                            currentMarker.setPopupContent(`<b>Sensor GreenRoots</b><br>Humedad: ${humedad}%<br>Lat: ${latitud.toFixed(6)}, Lon: ${longitud.toFixed(6)}`).openPopup();
                        } else {
                            // Crea un nuevo marcador
                            currentMarker = L.marker(newLatLng).addTo(map)
                                .bindPopup(`<b>Sensor GreenRoots</b><br>Humedad: ${humedad}%<br>Lat: ${latitud.toFixed(6)}, Lon: ${longitud.toFixed(6)}`)
                                .openPopup();
                        }
                        
                        // Centra el mapa en el marcador
                        if (!map.getBounds().contains(newLatLng)) {
                           map.setView(newLatLng, 13);
                        }
                        
                    } else if (map && latitud !== null && longitud !== null) {
                        // Caso especial: Inicializaci√≥n de marcador si a√∫n no existe
                          const newLatLng = new L.LatLng(latitud, longitud);
                          currentMarker = L.marker(newLatLng).addTo(map)
                            .bindPopup(`<b>Sensor GreenRoots</b><br>Humedad: ${humedad}%<br>Lat: ${latitud.toFixed(6)}, Lon: ${longitud.toFixed(6)}`)
                            .openPopup();
                          map.setView(newLatLng, 13);
                    }
                    
                    // 3. Actualizar el estado y la hora
                    const timeString = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                    estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Monitoreando RTDB.`;
                    ultimaActElement.textContent = timeString;

                } else {
                    humElement.textContent = latElement.textContent = lonElement.textContent = '--';
                    estadoElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> Conectado, pero el nodo /greenroots est√° vac√≠o.`;
                    ultimaActElement.textContent = 'N/A';
                    
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                        currentMarker = null;
                    }
                }
            }, (error) => {
                console.error("Error al leer datos del sensor:", error);
                estadoElement.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger-red);"></i> Error de lectura de datos.`;
                ultimaActElement.textContent = 'Error';
            });
        }


        // üö® 1. CARGAR DATOS PENDIENTES DESDE EL BACKEND
        // ... (c√≥digo anterior)

 // üö® 1. CARGAR DATOS PENDIENTES DESDE EL BACKEND
        async function loadPendingRegistries() {
            listaRegistros.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando registros pendientes...</li>';
            
            try {
                // Verificar si tenemos los headers antes de hacer la llamada
                const headers = getAuthHeaders();
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                console.log('Fetching pending registrations from:', `${API_URL}/admin/validacion/pendientes`);
                
                const response = await fetch(`${API_URL}/admin/validacion/pendientes`, {
                    method: 'GET',
                    headers: headers // ‚úÖ Uso de la funci√≥n auxiliar
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (!response.ok || !data.registros) {
                     console.error('Error response:', data);
                     listaRegistros.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> Error: ${data.mensaje || 'Fallo al obtener registros.'}</li>`;
                     return [];
                }
                
                console.log('Returning registros:', data.registros);
                return data.registros;

            } catch (error) {
                console.error("Error al obtener registros pendientes:", error);
                // Muestra un mensaje amigable para el error de token
                const message = error.message.includes("Token") ? "Error de autenticaci√≥n. Por favor, reintenta iniciar sesi√≥n." : "Error de conexi√≥n con el servidor.";
                listaRegistros.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> ${message}</li>`;
                return [];
            }
        }


        // 2. FUNCI√ìN PARA ACTUALIZAR LA INTERFAZ (UI)
        async function updateValidationUI() {
            const registrosPendientes = await loadPendingRegistries();
            
            console.log('Total pending registrations:', registrosPendientes.length);
            console.log('Registrations data:', registrosPendientes);
            
            listaRegistros.innerHTML = '';
            contadorElemento.textContent = registrosPendientes.length;

            if (registrosPendientes.length === 0) {
                noPendingMessage.style.display = 'block';
                return;
            } else {
                noPendingMessage.style.display = 'none';
            }

            // Crear y a√±adir elementos
            registrosPendientes.forEach(registro => {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-id', registro.id); 
                listItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;';
                
                // Los campos vienen en min√∫sculas desde el backend
                const tipo = registro.tipodearbol || '√Årbol (Desconocido)';
                const voluntario = registro.voluntarioid || 'ID Desconocido'; 
                const icono = tipo.includes('√Årbol') ? 'fas fa-tree' : 'fas fa-leaf';

                listItem.innerHTML = `
                    <span><i class="${icono}" style="margin-right: 8px;"></i>${tipo} - Vol: ${voluntario}</span>
                    <div>
                        <button class="submit-btn btn-sm btn-approve" data-id="${registro.id}" style="width: auto; background: var(--success-green); margin-right: 5px;">
                            <i class="fas fa-thumbs-up"></i> Aprobar
                        </button>
                        <button class="submit-btn btn-sm btn-reject" data-id="${registro.id}" style="width: auto; background: var(--danger-red);">
                            <i class="fas fa-times"></i> Rechazar
                        </button>
                    </div>
                `;
                listaRegistros.appendChild(listItem);
            });
            
            addValidationEventListeners();
        }

        // üö® 3. FUNCI√ìN PARA GESTIONAR LA VALIDACI√ìN (CONECTADO AL BACKEND)
        function handleValidation(e) {
            const button = e.currentTarget;
            const isApprove = button.classList.contains('btn-approve');
            // Enviamos el estado con May√∫scula Inicial (Aprobado/Rechazado)
            const nuevoEstado = isApprove ? 'Aprobado' : 'Rechazado'; 
            const itemId = button.getAttribute('data-id');
            const listItem = button.closest('li');

            // Deshabilitar botones mientras se procesa
            listItem.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                btn.textContent = isApprove ? 'Enviando...' : 'Procesando...';
            });

            let motivoRechazo = null;

            if (!isApprove) {
                 motivoRechazo = prompt(`Ingrese el motivo del rechazo para el registro #${itemId}:`);
                 if (!motivoRechazo) {
                     // Si el admin cancela o no da motivo, restaurar botones y salir
                     listItem.querySelectorAll('button').forEach(btn => btn.disabled = false);
                     listItem.querySelector('.btn-approve').textContent = 'Aprobar';
                     listItem.querySelector('.btn-reject').textContent = 'Rechazar';
                     return;
                 }
            }
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                // Llamada a la API
                fetch(`${API_URL}/admin/validacion/${itemId}`, {
                    method: 'PATCH',
                    headers: headers, // ‚úÖ Uso de la funci√≥n auxiliar
                    body: JSON.stringify({ 
                        nuevoestado: nuevoEstado, // Campo en min√∫sculas para el backend
                        motivorechazo: motivoRechazo // Campo en min√∫sculas para el backend
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.ok) {
                        alert(`‚ùå Fallo en el servidor: ${data.mensaje}`);
                        return;
                    }
                    
                    alert(`‚úÖ Registro #${itemId} ha sido ${nuevoEstado}.`);
                    // Remover el elemento validado de la UI
                    listItem.remove();
                    // Actualizar el contador 
                    contadorElemento.textContent = parseInt(contadorElemento.textContent) - 1;
                    if (parseInt(contadorElemento.textContent) === 0) {
                         noPendingMessage.style.display = 'block';
                    }

                })
                .catch(error => {
                    console.error("Error de conexi√≥n/servidor:", error);
                    alert("‚ùå Error de conexi√≥n al validar el registro.");
                })
                .finally(() => {
                    // Restaurar botones si no hubo remoci√≥n (en caso de error de servidor)
                    listItem.querySelectorAll('button').forEach(btn => btn.disabled = false);
                    listItem.querySelector('.btn-approve').textContent = 'Aprobar';
                    listItem.querySelector('.btn-reject').textContent = 'Rechazar';
                });
            } catch (error) {
                 console.error(error.message);
                 alert(error.message);
                 // Restaurar botones si la obtenci√≥n del token falla
                 listItem.querySelectorAll('button').forEach(btn => btn.disabled = false);
                 listItem.querySelector('.btn-approve').textContent = 'Aprobar';
                 listItem.querySelector('.btn-reject').textContent = 'Rechazar';
            }
        }
        // 4. ASIGNAR ESCUCHADORES DE EVENTOS
        function addValidationEventListeners() {
            document.querySelectorAll('.btn-approve, .btn-reject').forEach(btn => {
                btn.removeEventListener('click', handleValidation); 
                btn.addEventListener('click', handleValidation);
            });
        }

        // Event listener for refresh button
        document.getElementById('refreshBtn')?.addEventListener('click', () => {
            console.log('Refresh button clicked');
            updateValidationUI();
        });

        // Event listener for diagnostic button
        document.getElementById('diagnosticBtn')?.addEventListener('click', async () => {
            console.log('Diagnostic button clicked');
            listaRegistros.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Diagnosticando base de datos...</li>';
            
            try {
                const response = await fetch(`${API_URL}/admin/validacion/all`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Rol': userData.rol || 'Administrador' 
                    }
                });
                
                const data = await response.json();
                console.log('Diagnostic results:', data);
                
                if (!response.ok) {
                    alert(`Error: ${data.mensaje || 'No se pudo obtener datos'}`);
                    return;
                }
                
                // Show diagnostic info
                const total = data.total || 0;
                const registros = data.registros || [];
                
                // Count by status
                const statusCount = {};
                registros.forEach(r => {
                    const status = r.estadovalidacion || 'undefined';
                    statusCount[status] = (statusCount[status] || 0) + 1;
                });
                
                const diagnosticInfo = `Total registros: ${total}\n\nDistribuci√≥n por estado:\n${JSON.stringify(statusCount, null, 2)}\n\nRegistros:\n${JSON.stringify(registros, null, 2)}`;
                
                console.log('=== DIAGNOSTIC INFO ===');
                console.log(diagnosticInfo);
                alert(`Total registros: ${total}\n\nEstados encontrados:\n${JSON.stringify(statusCount, null, 2)}\n\nVer detalles en consola (F12)`);
                
            } catch (error) {
                console.error("Error en diagn√≥stico:", error);
                alert("Error al diagnosticar base de datos. Ver consola para detalles.");
            }
        });

        // ===================================
        // USER MANAGEMENT FUNCTIONS
        // ===================================
        
       async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando usuarios...</li>';
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/usuarios`, {
                    headers: headers // ‚úÖ Uso de la funci√≥n auxiliar
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al cargar usuarios');
                }
                
                const usuarios = data.usuarios || [];
                displayUsers(usuarios);
                
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</li>`;
            }
        }
        
        function displayUsers(usuarios) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            if (usuarios.length === 0) {
                usersList.innerHTML = '<li>No hay usuarios registrados.</li>';
                return;
            }
            
            usuarios.forEach(usuario => {
                const userItem = document.createElement('div');
                userItem.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;';
                userItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${usuario.nombre || 'Sin nombre'}</strong><br>
                            <small>${usuario.email}</small><br>
                            <span class="role-badge" style="background: ${getRoleColor(usuario.rol)}; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white;">
                                ${usuario.rol}
                            </span>
                            <span style="margin-left: 10px; color: ${usuario.activo ? 'green' : 'red'};">
                                ${usuario.activo ? '‚úì Activo' : '‚úó Inactivo'}
                            </span>
                        </div>
                        <div>
                            <select id="roleSelect_${usuario.uid}" class="role-select" style="margin-right: 10px; padding: 5px;">
                                <option value="Voluntario" ${usuario.rol === 'Voluntario' ? 'selected' : ''}>Voluntario</option>
                                <option value="Administrador" ${usuario.rol === 'Administrador' ? 'selected' : ''}>Administrador</option>
                                <option value="Gobierno" ${usuario.rol === 'Gobierno' ? 'selected' : ''}>Gobierno</option>
                            </select>
                            <button onclick="updateUser('${usuario.uid}')" class="btn btn-sm" style="background: var(--primary-green);">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button onclick="toggleUserStatus('${usuario.uid}', ${usuario.activo})" class="btn btn-sm" style="background: ${usuario.activo ? 'orange' : 'green'}; margin-left: 5px;">
                                <i class="fas fa-${usuario.activo ? 'ban' : 'check'}"></i> ${usuario.activo ? 'Desactivar' : 'Activar'}
                            </button>
                            <button onclick="deleteUser('${usuario.uid}')" class="btn btn-sm" style="background: var(--danger-red); margin-left: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                usersList.appendChild(userItem);
            });
        }
        
        function getRoleColor(rol) {
            const colors = {
                'Voluntario': '#2d5f4f',
                'Administrador': '#d9534f',
                'Gobierno': '#5bc0de'
            };
            return colors[rol] || '#6c757d';
        }
        
        async function updateUser(uid) {
            const select = document.getElementById(`roleSelect_${uid}`);
            const newRole = select.value;
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/usuarios/${uid}`, {
                    method: 'PATCH',
                    headers: headers, // ‚úÖ Uso de la funci√≥n auxiliar
                    body: JSON.stringify({ nuevorol: newRole })
                });
                
                const data = await response.json();
                // ... (resto del c√≥digo sin cambios)
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error al actualizar usuario');
            }
        }
        
        async function toggleUserStatus(uid, isActive) {
            const newState = isActive ? 'inactivo' : 'activo';
            
            if (!confirm(`¬øSeguro que deseas ${isActive ? 'desactivar' : 'activar'} este usuario?`)) {
                return;
            }
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/usuarios/${uid}`, {
                    method: 'PATCH',
                    headers: headers, // ‚úÖ Uso de la funci√≥n auxiliar
                    body: JSON.stringify({ estado: newState })
                });
                
                const data = await response.json();
                // ... (resto del c√≥digo sin cambios)
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error al actualizar estado');
            }
        }
        
        async function deleteUser(uid) {
            if (!confirm('¬øSeguro que deseas eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }
                
                const response = await fetch(`${API_URL}/admin/usuarios/${uid}`, {
                    method: 'DELETE',
                    headers: headers // ‚úÖ Uso de la funci√≥n auxiliar
                });
                
                const data = await response.json();
                // ... (resto del c√≥digo sin cambios)
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error al eliminar usuario');
            }
        }
        
        // Event listeners for user management
        document.getElementById('loadUsersBtn')?.addEventListener('click', () => {
            const section = document.getElementById('userManagementSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                loadUsers();
            }
        });
        
        // ===================================
        // CAMPAIGN MANAGEMENT FUNCTIONS
        // ===================================
        
        async function loadEventos() {
            const eventoList = document.getElementById('eventoList');
            eventoList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando eventos...</li>';
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/eventos`, {
                    headers: headers // ‚úÖ Uso de la funci√≥n auxiliar
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al cargar eventos');
                }
                
                const eventos = data.eventos || [];
                displayEventos(eventos);
                
            } catch (error) {
                console.error('Error loading eventos:', error);
                eventoList.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</li>`;
            }
        }

        function displayEventos(eventos) {
            const eventoList = document.getElementById('eventoList');
            eventoList.innerHTML = '';
            
            if (eventos.length === 0) {
                eventoList.innerHTML = '<p>No hay eventos creados. Crea el primer evento.</p>';
                return;
            }
            
            eventos.forEach(evento => {
                const eventoItem = document.createElement('div');
                eventoItem.style.cssText = 'background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd;';
                
                const fechaEvento = evento.fecha ? new Date(evento.fecha).toLocaleDateString('es-ES') : 'N/A';
                const horaEvento = evento.hora || 'No especificada';
                
                eventoItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0;">
                                ${evento.titulo} 
                                <span style="background: ${evento.activo ? 'green' : 'gray'}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
                                    ${evento.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </h4>
                            <p style="margin: 0 0 10px 0; color: #666;">${evento.descripcion}</p>
                            <small style="color: #999; display: block; margin-bottom: 5px;">
                                <i class="fas fa-calendar"></i> Fecha: ${fechaEvento}
                            </small>
                            <small style="color: #999; display: block; margin-bottom: 5px;">
                                <i class="fas fa-clock"></i> Hora: ${horaEvento}
                            </small>
                            <small style="color: #999;">
                                <i class="fas fa-map-marker-alt"></i> ${evento.ubicacion || 'No especificada'}
                            </small>
                        </div>
                        <div>
                            <button onclick="deleteEvento('${evento.id}')" class="btn btn-sm" style="background: var(--danger-red);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                eventoList.appendChild(eventoItem);
            });
        }
        
        async function deleteEvento(id) {
            if (!confirm('¬øSeguro que deseas eliminar este evento?')) {
                return;
            }
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/eventos/${id}`, {
                    method: 'DELETE',
                    headers: headers // ‚úÖ Uso de la funci√≥n auxiliar
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(`Error: ${data.mensaje}`);
                    return;
                }
                
                alert('Evento eliminado');
                loadEventos();
                
            } catch (error) {
                console.error('Error deleting evento:', error);
                alert('Error al eliminar evento');
            }
        }
        
        // Event listeners for event management
        document.getElementById('showEventosBtn')?.addEventListener('click', () => {
            const section = document.getElementById('eventoManagementSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                loadEventos();
            }
        });
        
        document.getElementById('createEventoBtn')?.addEventListener('click', () => {
            document.getElementById('createEventoModal').style.display = 'flex';
        });
        
        document.getElementById('closeEventoModal')?.addEventListener('click', () => {
            document.getElementById('createEventoModal').style.display = 'none';
            document.getElementById('createEventoForm').reset();
        });
        
        document.getElementById('createEventoForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                titulo: document.getElementById('eventoTitulo').value,
                descripcion: document.getElementById('eventoDescripcion').value,
                fecha: document.getElementById('eventoFecha').value,
                hora: document.getElementById('eventoHora').value,
                ubicacion: document.getElementById('eventoUbicacion').value,
                activo: document.getElementById('eventoActivo').checked
            };
            
            try {
                const headers = getAuthHeaders(); // ‚úÖ Obtener headers aqu√≠
                if (!headers['Authorization']) {
                    throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
                }

                const response = await fetch(`${API_URL}/admin/eventos`, {
                    method: 'POST',
                    headers: headers, // ‚úÖ Uso de la funci√≥n auxiliar
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    alert(`Error: ${result.mensaje}`);
                    return;
                }
                
                alert('Evento creado exitosamente');
                document.getElementById('createEventoModal').style.display = 'none';
                document.getElementById('createEventoForm').reset();
                loadEventos();
                
            } catch (error) {
                console.error('Error creating evento:', error);
                alert('Error al crear evento');
            }
        });
        
        document.getElementById('loadUsersBtnAlt')?.addEventListener('click', () => {
            const section = document.getElementById('userManagementSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                loadUsers();
            }
        });

        // L√≥gica de Cerrar Sesi√≥n
        document.getElementById("logoutBtn").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            alert("Has cerrado sesi√≥n.");
            window.location.replace("login.html");
        });

        // Inicializar la lista, el mapa y Firebase al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
             if (isAllowed) {
                // [Existente] Carga UI de validaci√≥n
                updateValidationUI();
                
                // [NUEVO] Inicializar Mapa y Firebase
                initializeMap();
                const firebaseReady = await initializeFirebase();
                if (firebaseReady) {
                    loadSensorData();
                }
             }
        });
    </script>
</body>
</html>