<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Green Roots</title>
    
    <link rel="manifest" href="/manifest.json"> 
    <link rel="stylesheet" href="/home.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="module" src="/indexeddb-utils.js"></script>
    <style>
        /* CSS adicional para asegurar que el mapa se renderice correctamente */
        #mapContainer {
            height: 400px; /* Altura crucial para Leaflet */
            width: 100%;
        }
    </style>
    
    <script>
        // Funci√≥n de Protecci√≥n de Ruta (Solo permite 'Administrador' con May√∫scula Inicial)
        function protectRoute(allowedRoles) {
            const userDataJSON = localStorage.getItem("usuario");
            const loginPage = "login.html";
            const homePage = "index.html"; 

            if (!userDataJSON) {
                // No hay sesi√≥n
                window.location.replace(loginPage);
                return false;
            }

            const userData = JSON.parse(userDataJSON);
            // Obtenemos el rol con la May√∫scula Inicial de Firestore (ej: 'Administrador')
            const userRol = userData.rol?.trim(); 

            // Check if the user's role (case-insensitive) matches any allowed role
            const userRolLower = userRol?.toLowerCase();
            const allowedRolesLower = allowedRoles.map(r => r.toLowerCase());
            
            if (!userRol || !allowedRolesLower.includes(userRolLower)) {
                // Sesi√≥n, pero rol incorrecto
                alert("Acceso denegado. Solo el rol Administrador tiene acceso a este panel.");
                window.location.replace(homePage);
                return false;
            }
            return true;
        }

        // üö® Llama a la funci√≥n de protecci√≥n: Solo 'Administrador'
        const isAllowed = protectRoute(['Administrador']);
        
        if (!isAllowed) {
            // Detiene la carga del script si no est√° permitido
            throw new Error("Acceso no autorizado. Redirecci√≥n en curso."); 
        }
    </script>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <img src="/Green_Roots.jpg" alt="Green Roots Logo" class="logo-img">
                    <h1>Administrador</h1>
                </div>
                <div class="auth-buttons" style="display: flex; gap: 10px;">
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                    <a id="logoutBtn" href="#" class="nav-link logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
                </div>
            </div>
        </nav>
    </header>
    
    <main style="padding-top: 100px; padding-bottom: 40px;">
        <div class="container">
            <h2 class="section-title">Gesti√≥n Central y Validaci√≥n de Datos ‚öôÔ∏è</h2>

            <div class="info-grid">
                <section class="card validation-queue info-card warning">
                    <div class="card-icon" style="background: var(--warning-orange);"><i class="fas fa-check-double"></i></div>
                    <h3>Registros Pendientes de Validaci√≥n (<span id="validationCount">0</span>)</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Asegure la trazabilidad y transparencia del impacto.</p>
                    <button id="refreshBtn" class="submit-btn" style="width: 100%; background: var(--primary-green); margin-bottom: 10px;">
                        <i class="fas fa-sync-alt"></i> Actualizar Lista
                    </button>
                    <button id="diagnosticBtn" class="submit-btn" style="width: 100%; background: var(--warning-orange); margin-bottom: 10px;">
                        <i class="fas fa-search"></i> Diagnosticar Base de Datos
                    </button>
                    <ul id="registrosPendientes" style="list-style: none; padding-left: 0;">
                        <li><i class="fas fa-spinner fa-spin"></i> Cargando registros...</li>
                    </ul>
                    <p id="noPending" style="text-align: center; color: var(--success-green); font-weight: 600; display: none;">‚úÖ ¬°No hay registros pendientes!</p>
                </section>

                <section class="card management-tools info-card">
                    <div class="card-icon"><i class="fas fa-tasks"></i></div>
                    <h3>Gesti√≥n de Eventos</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Crea y gestiona eventos para voluntarios.</p>
                    <button id="showEventosBtn" class="submit-btn" style="background: var(--light-green); margin-bottom: 10px;">
                        <i class="fas fa-bullhorn"></i> Ver Eventos
                    </button>
                    <button id="createEventoBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 10px;">
                        <i class="fas fa-plus"></i> Crear Nuevo Evento
                    </button>
                    <button id="loadUsersBtnAlt" class="submit-btn" style="background: var(--forest-green); margin-bottom: 10px;">
                        <i class="fas fa-users-cog"></i> Gestionar Usuarios
                    </button>
                </section>
            </div>

            <section class="card user-management-card" style="margin-top: 40px; padding: 30px; display: none;" id="userManagementSection">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios</h3>
                <button id="loadUsersBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 15px;">
                    <i class="fas fa-sync-alt"></i> Cargar Usuarios
                </button>
                <div id="usersList" style="max-height: 500px; overflow-y: auto;">
                    </div>
            </section>

            <section class="card event-management-card" style="margin-top: 40px; padding: 30px; display: none;" id="eventoManagementSection">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-calendar"></i> Gesti√≥n de Eventos</h3>
                <div id="eventoList" style="margin-bottom: 20px;">
                    </div>
            </section>

            <div id="createEventoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Crear Nuevo Evento</h3>
                    <form id="createEventoForm">
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Nombre del Evento *</label>
                            <input type="text" id="eventoTitulo" required placeholder="Ej: Jornada de Reforestaci√≥n Zona Norte">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Descripci√≥n *</label>
                            <textarea id="eventoDescripcion" required rows="3" placeholder="Describe el evento..."></textarea>
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Fecha del Evento</label>
                            <input type="date" id="eventoFecha" required>
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Hora del Evento</label>
                            <input type="time" id="eventoHora">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Ubicaci√≥n</label>
                            <input type="text" id="eventoUbicacion" placeholder="Ej: Parque Central">
                        </div>
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label>Estado</label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="eventoActivo" checked style="width: auto;">
                                <span>Evento Activo</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="submit-btn" style="background: var(--primary-green); flex: 1;">
                                <i class="fas fa-save"></i> Crear
                            </button>
                            <button type="button" class="submit-btn" id="closeEventoModal" style="background: var(--danger-red); flex: 1;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <section class="card impact-charts" style="margin-top: 40px; padding: 30px;">
                <h4 class="activity-title"><i class="fas fa-satellite-dish"></i> Monitoreo en Tiempo Real y Visualizaci√≥n de Impacto</h4>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-tint" style="color: var(--primary-green);"></i>
                        <p style="margin: 5px 0 0 0;">Humedad (%)</p>
                        <strong id="humedad-sensor" style="font-size: 1.5em; color: var(--primary-green);">--</strong>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-map-pin" style="color: #6c757d;"></i>
                        <p style="margin: 5px 0 0 0;">Latitud</p>
                        <strong id="latitud-sensor" style="font-size: 1.1em;">--</strong>
                    </div>
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
                        <i class="fas fa-map-pin" style="color: #6c757d;"></i>
                        <p style="margin: 5px 0 0 0;">Longitud</p>
                        <strong id="longitud-sensor" style="font-size: 1.1em;">--</strong>
                    </div>
                </div>

                <div id="graficoEspecies" style="margin-bottom: 20px;">
                    <div id="mapContainer" style="height: 400px; width: 100%; border-radius: 10px; margin-bottom: 15px; z-index: 1;">
                        </div>
                </div>
                
                <p style="text-align: center; color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                    Estado de Conexi√≥n RTDB: <span id="estado-firebase">Inicializando...</span> | 
                    √öltima Actualizaci√≥n: <span id="ultima-actualizacion">N/A</span>
                </p>

                <p style="text-align: center; color: var(--text-light);"><i class="fas fa-filter"></i> **Filtros:** Comunidad, Especie, Zona Geogr√°fica, Rol (Aqu√≠ ir√≠an los dem√°s gr√°ficos de impacto)</p>
            </section>
            
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Green Roots. Panel de Administrador.</p>
            </div>
        </div>
    </footer>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
    import { openDB, putItem, getAllItems, STORE_EVENTOS } from '/indexeddb-utils.js';

    // La URL de tu Backend desplegado (Ajusta esto a tu URL real de Render)
    const API_URL = "https://greenroots-web.onrender.com/api"; 
    
    // Obtener datos del usuario (el rol se almacena como 'Administrador')
    const userData = localStorage.getItem("usuario") ? JSON.parse(localStorage.getItem("usuario")) : {};
    
    const listaRegistros = document.getElementById('registrosPendientes');
    const contadorElemento = document.getElementById('validationCount');
    const noPendingMessage = document.getElementById('noPending');
    
    // Elementos de Eventos y Usuarios
    const eventoList = document.getElementById('eventoList');
    const usersList = document.getElementById('usersList');
    const userManagementSection = document.getElementById('userManagementSection');
    const eventoManagementSection = document.getElementById('eventoManagementSection');
    
    // ==========================================================
    // ‚úÖ FUNCI√ìN CENTRAL PARA OBTENER LOS HEADERS
    // ==========================================================
    function getAuthHeaders() {
        const userToken = userData.token; 
        
        if (!userToken) {
            console.error("Token de autenticaci√≥n no encontrado.");
            return {};
        }

        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`, 
            'X-User-Rol': userData.rol || 'Administrador' 
        };
    }

    // ===============================================
    // Variables Globales para Firebase/Mapa
    // ===============================================
    let firebaseApp; 
    let db; 
    let map; 
    let currentMarker = null; 
    const DEFAULT_LAT = 42.3936888;
    const DEFAULT_LON = -71.0412802;
    
    // ===============================================
    // 1. FUNCIONES DE FIREBASE Y LEAFLET
    // ===============================================

    function initializeMap() {
        map = L.map('mapContainer').setView([DEFAULT_LAT, DEFAULT_LON], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        console.log("‚úÖ Mapa Leaflet inicializado con √©xito.");
    }

    async function initializeFirebase() {
        const estadoElement = document.getElementById('estado-firebase');
        if (!userData) {
            estadoElement.textContent = "Usuario no autenticado.";
            return false;
        }

        try {
            estadoElement.textContent = "Obteniendo configuraci√≥n...";
            
            const firebaseConfig = {
                databaseURL: "https://greenroot-6dbfe-default-rtdb.firebaseio.com/"
            };
            
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database(); 
            
            estadoElement.textContent = "Conectado al RTDB.";
            console.log("‚úÖ Conexi√≥n de Firebase inicializada con √©xito.");
            
            return true;
            
        } catch (error) { 
            console.error("‚ùå Fallo al inicializar Firebase:", error);
            estadoElement.textContent = `ERROR: ${error.message.split(":")[0] || "No se pudo conectar"}`;
            return false;
        }
    }
    
    function loadSensorData() {
        if (!db) {
            console.warn("No se puede iniciar el monitoreo: Firebase DB no est√° inicializada.");
            return;
        }

        const greenrootsRef = db.ref('greenroots'); 
        const humElement = document.getElementById('humedad-sensor');
        const latElement = document.getElementById('latitud-sensor');
        const lonElement = document.getElementById('longitud-sensor');
        const estadoElement = document.getElementById('estado-firebase');
        const ultimaActElement = document.getElementById('ultima-actualizacion');
        
        greenrootsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                const humedad = data.humedad !== undefined ? parseFloat(data.humedad).toFixed(1) : '--';
                const latitud = data.latitud !== undefined ? parseFloat(data.latitud) : null;
                const longitud = data.longitud !== undefined ? parseFloat(data.longitud) : null;

                humElement.textContent = humedad;
                latElement.textContent = latitud !== null ? latitud.toFixed(6) : '--';
                lonElement.textContent = longitud !== null ? longitud.toFixed(6) : '--';

                if (map && latitud !== null && longitud !== null) {
                    const newLatLng = new L.LatLng(latitud, longitud);

                    if (currentMarker) {
                        currentMarker.setLatLng(newLatLng);
                        currentMarker.setPopupContent(`<b>Sensor GreenRoots</b><br>Humedad: ${humedad}%<br>Lat: ${latitud.toFixed(6)}, Lon: ${longitud.toFixed(6)}`).openPopup();
                    } else {
                        currentMarker = L.marker(newLatLng).addTo(map)
                            .bindPopup(`<b>Sensor GreenRoots</b><br>Humedad: ${humedad}%<br>Lat: ${latitud.toFixed(6)}, Lon: ${longitud.toFixed(6)}`)
                            .openPopup();
                    }
                    
                    if (!map.getBounds().contains(newLatLng)) {
                       map.setView(newLatLng, 13);
                    }
                }
                
                const timeString = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Monitoreando RTDB.`;
                ultimaActElement.textContent = timeString;

            } else {
                humElement.textContent = latElement.textContent = lonElement.textContent = '--';
                estadoElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> Conectado, pero el nodo /greenroots est√° vac√≠o.`;
                ultimaActElement.textContent = 'N/A';
                
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
            }
        }, (error) => {
            console.error("Error al leer datos del sensor:", error);
            estadoElement.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger-red);"></i> Error de lectura de datos.`;
            ultimaActElement.textContent = 'Error';
        });
    }

    // ===============================================
    // 2. FUNCIONES DE VALIDACI√ìN (REGISTROS PENDIENTES)
    // ===============================================

    async function loadPendingRegistries() {
        // ... (Tu c√≥digo para loadPendingRegistries) ...
        // [C√ìDIGO OMITIDO POR SER EXTENSO, PERO DEBE ESTAR AQU√ç]
        listaRegistros.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando registros pendientes...</li>';
        try {
            const headers = getAuthHeaders();
            if (!headers['Authorization']) {
                throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
            }
            const response = await fetch(`${API_URL}/admin/validacion/pendientes`, { headers: headers });
            const data = await response.json();
            if (!response.ok || !data.registros) {
                listaRegistros.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> Error: ${data.mensaje || 'Fallo al obtener registros.'}</li>`;
                return [];
            }
            return data.registros;
        } catch (error) {
            const message = error.message.includes("Token") ? "Error de autenticaci√≥n. Por favor, reintenta iniciar sesi√≥n." : "Error de conexi√≥n con el servidor.";
            listaRegistros.innerHTML = `<li style="color: red;"><i class="fas fa-exclamation-circle"></i> ${message}</li>`;
            return [];
        }
    }

    async function updateValidationUI() {
        const registrosPendientes = await loadPendingRegistries();
        listaRegistros.innerHTML = '';
        contadorElemento.textContent = registrosPendientes.length;

        if (registrosPendientes.length === 0) {
            noPendingMessage.style.display = 'block';
            return;
        } else {
            noPendingMessage.style.display = 'none';
        }

        registrosPendientes.forEach(registro => {
            const listItem = document.createElement('li');
            listItem.setAttribute('data-id', registro.id);
            listItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;'; 
            const tipo = registro.tipodearbol || '√Årbol (Desconocido)';
            const voluntario = registro.voluntarioid || 'ID Desconocido';
            const icono = tipo.includes('√Årbol') ? 'fas fa-tree' : 'fas fa-leaf';

            listItem.innerHTML = `
                <span><i class="${icono}" style="margin-right: 8px;"></i>${tipo} - Vol: ${voluntario}</span>
                <div>
                    <button class="submit-btn btn-sm btn-approve" data-id="${registro.id}" style="width: auto; background: var(--success-green); margin-right: 5px;">
                        <i class="fas fa-thumbs-up"></i> Aprobar
                    </button>
                    <button class="submit-btn btn-sm btn-reject" data-id="${registro.id}" style="width: auto; background: var(--danger-red);">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            `;
            listaRegistros.appendChild(listItem);
        });
        addValidationEventListeners();
    }

    // Funciones de validaci√≥n interna (no necesitan exposici√≥n global)
    function addValidationEventListeners() {
        document.querySelectorAll('.btn-approve, .btn-reject').forEach(button => {
            button.removeEventListener('click', handleValidation); // Evitar duplicados
            button.addEventListener('click', handleValidation);
        });
    }

    // La funci√≥n handleValidation solo debe extraer los datos y llamar a la funci√≥n de API
function handleValidation(e) {
    const button = e.currentTarget;
    const isApprove = button.classList.contains('btn-approve');
    const nuevoEstado = isApprove ? 'Aprobado' : 'Rechazado';
    const itemId = button.getAttribute('data-id');
    const listItem = button.closest('li');

    // Deshabilitar botones mientras se procesa
    listItem.querySelectorAll('button').forEach(btn => {
        btn.disabled = true;
        btn.textContent = isApprove ? 'Aprobando...' : 'Procesando...';
    });

    let motivoRechazo = null;

    if (!isApprove) {
        motivoRechazo = prompt(`Ingrese el motivo del rechazo para el registro #${itemId}:`);
        if (!motivoRechazo) {
            // Si el admin cancela, restaurar botones y salir
            listItem.querySelectorAll('button').forEach(btn => btn.disabled = false);
            listItem.querySelector('.btn-approve').textContent = 'Aprobar';
            listItem.querySelector('.btn-reject').textContent = 'Rechazar';
            return;
        }
    }
    
    // Llamar a la funci√≥n as√≠ncrona principal
    validateRegistry(itemId, nuevoEstado, motivoRechazo, listItem);
}
    /**
 * Maneja la l√≥gica de la API para la validaci√≥n del registro.
 */
async function validateRegistry(itemId, nuevoEstado, motivo, listItem) {
    try {
        const headers = getAuthHeaders();
        if (!headers['Authorization']) {
            throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
        }

        // üö® CORRECCI√ìN CLAVE AQU√ç üö®
        const bodyData = { 
            nuevoestado: nuevoEstado,
            // ‚ùå Eliminada la l√≠nea incorrecta 'motivoRechazo: motivoRechazo,'
        };
        
        // ‚úÖ Se a√±ade el motivo SOLO si existe (para rechazo) 
        // y se utiliza la clave que el servidor espera: 'motivorechazo'
        if (motivo) {
             bodyData.motivorechazo = motivo; // Clave correcta en min√∫sculas
        }

        const response = await fetch(`${API_URL}/admin/validacion/${itemId}`, {
            method: 'PATCH',
            headers: { 
                ...headers, 
                'Content-Type': 'application/json' // Es importante asegurar el Content-Type
            },
            body: JSON.stringify(bodyData)
        });
        
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.mensaje || 'Error al validar registro');
        }

        // √âXITO: Animaci√≥n de remoci√≥n y recarga de UI
        alert(`‚úÖ Registro #${itemId} ha sido ${nuevoEstado}.`);
        listItem.style.transition = 'all 0.5s ease-out';
        listItem.style.opacity = '0';
        
        setTimeout(() => {
            updateValidationUI(); 
        }, 500);

    } catch (error) {
        console.error('Error de validaci√≥n:', error);
        alert(`‚ùå Fallo en la validaci√≥n del registro #${itemId}: ${error.message}`);
        
        // RESTAURAR botones en caso de error
        listItem.querySelectorAll('button').forEach(btn => { btn.disabled = false; });
        listItem.querySelector('.btn-approve').textContent = 'Aprobar';
        listItem.querySelector('.btn-reject').textContent = 'Rechazar';
    }
}


    // ===============================================
    // 3. FUNCIONES DE GESTI√ìN DE EVENTOS
    // ===============================================

    function displayEventos(eventos) {
        eventoList.innerHTML = '';
        if (eventos.length === 0) {
            eventoList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay eventos disponibles.</p>';
            return;
        }

        eventos.forEach(evento => {
            const card = document.createElement('div');
            card.className = 'card event-card';
            card.style.cssText = 'margin-bottom: 15px; padding: 20px; border-left: 5px solid var(--primary-green);';
            card.innerHTML = `
                <h4>${evento.titulo || 'Sin T√≠tulo'} (${evento.activo ? 'Activo' : 'Inactivo'})</h4>
                <p style="margin-bottom: 5px;">üìç ${evento.ubicacion || 'Ubicaci√≥n Pendiente'}</p>
                <p style="margin-bottom: 10px;">üìÖ ${evento.fecha || 'Fecha Pendiente'}</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="submit-btn" style="background: var(--warning-orange); width: auto;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="deleteEvento('${evento.id}')" class="submit-btn" style="background: var(--danger-red); width: auto;">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            eventoList.appendChild(card);
        });
    }

    /**
     * ‚úÖ CORRECCI√ìN: Con l√≥gica de respaldo a IndexedDB
     */
    async function loadEventos() {
        eventoList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando eventos...</li>';
        
        let eventos = [];
        let isOffline = false;

        // 1. INTENTAR CARGAR DE LA API (Online)
        try {
            const headers = getAuthHeaders();
            if (!headers['Authorization']) {
                throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
            }

            const response = await fetch(`${API_URL}/admin/eventos`, { headers: headers });
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.mensaje || 'Error del servidor al cargar eventos');
            }
            
            eventos = data.eventos || [];

        } catch (error) {
            console.warn('‚ùå Fallo al cargar eventos desde la API. Intentando IndexedDB...', error.message);
            isOffline = true;
            
            // 2. RECURRIR A INDEXEDDB (Offline/Fallback)
            try {
                eventos = await getAllItems(STORE_EVENTOS); 
                
                if (eventos.length === 0) {
                     eventoList.innerHTML = `<li style="color: gray; list-style: none;">
                        <i class="fas fa-info-circle"></i> No hay eventos guardados localmente.
                    </li>`;
                    return;
                }
                
            } catch (dbError) {
                console.error('‚ùå Error fatal: No se pudo leer ni de la API ni de IndexedDB:', dbError);
                 eventoList.innerHTML = `<li style="color: red; list-style: none;">
                    <i class="fas fa-exclamation-triangle"></i> No hay conexi√≥n, y fall√≥ la carga local.
                </li>`;
                return;
            }
        }

        // 3. MOSTRAR RESULTADOS
        if (isOffline) {
            eventoList.innerHTML = `<li style="color: var(--warning-orange); margin-bottom: 10px; list-style: none;">
                <i class="fas fa-wifi-slash"></i> Mostrando datos locales (Modo sin conexi√≥n).
            </li>`;
        } else {
            eventoList.innerHTML = ''; 
        }
        
        displayEventos(eventos);
    }


    /**
     * Funci√≥n que se llama desde onclick en la tabla de Eventos.
     * ‚úÖ NECESITA EXPOSICI√ìN GLOBAL.
     */
    async function deleteEvento(eventoId) {
        if (!confirm(`¬øEst√°s seguro de eliminar el evento ${eventoId}? Esta acci√≥n es irreversible.`)) {
            return;
        }
        
        try {
            const headers = getAuthHeaders();
            const response = await fetch(`${API_URL}/admin/eventos/${eventoId}`, {
                method: 'DELETE',
                headers: headers
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.mensaje || 'Error al eliminar evento');
            }

            alert('Evento eliminado correctamente.');
            loadEventos(); 
            
        } catch (error) {
            console.error('Error al eliminar evento:', error);
            alert(`Fallo en la eliminaci√≥n: ${error.message}`);
        }
    }


    // ===============================================
    // 4. FUNCIONES DE GESTI√ìN DE USUARIOS
    // ===============================================

    function displayUsers(users) {
    const usersList = document.getElementById('usersList'); // Asegurar que esta variable est√° disponible
    usersList.innerHTML = ''; // Limpiar lista
    
    if (users.length === 0) {
        usersList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay usuarios registrados.</p>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'users-table';
    table.style.cssText = 'width: 100%; border-collapse: collapse;';
    table.innerHTML = `
        <thead>
            <tr style="background: var(--light-bg);">
                <th style="padding: 10px; text-align: left;">ID</th>
                <th style="padding: 10px; text-align: left;">Email</th>
                <th style="padding: 10px; text-align: center;">Rol Actual</th>
                <th style="padding: 10px; text-align: center;">Acciones</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    const tbody = table.querySelector('tbody');

    users.forEach(user => {
        // üö® CORRECCI√ìN CLAVE: Usar 'user.uid' en lugar de 'user.id'
        if (!user || !user.uid || !user.email || !user.rol) { 
            console.warn('Usuario con datos incompletos o inv√°lidos omitido:', user);
            return; // Omite este registro
        }
        
        const shortId = user.uid.substring(0, 8); // Usamos uid para el substring
        const userId = user.uid; // El ID completo para las funciones de acci√≥n

        const row = tbody.insertRow();
        row.innerHTML = `
            <td style="padding: 10px;">${shortId}...</td>
            <td style="padding: 10px;">${user.email}</td>
            <td style="padding: 10px; text-align: center;">
                <span style="font-weight: bold; color: ${user.rol.toLowerCase() === 'administrador' ? 'var(--danger-red)' : 'var(--primary-green)'}">${user.rol}</span>
            </td>
            <td style="padding: 10px; text-align: center;">
    <select id="roleSelect-${shortId}" onchange="updateUser('${userId}')" style="padding: 5px; border-radius: 5px; margin-right: 10px;">
        <option value="Voluntario" ${user.rol === 'Voluntario' ? 'selected' : ''}>Voluntario</option>
        <option value="Administrador" ${user.rol === 'Administrador' ? 'selected' : ''}>Administrador</option>
        <option value="Gobierno" ${user.rol === 'Gobierno' ? 'selected' : ''}>Gobierno</option>
    </select>
    <button onclick="deleteUser('${userId}')" class="submit-btn" style="background: var(--danger-red); width: auto; padding: 5px 10px;">
        <i class="fas fa-user-minus"></i>
    </button>
</td>
        `;
    });

    usersList.appendChild(table);
}

    /**
     * Funci√≥n que se llama desde onchange en la tabla de Usuarios.
     * ‚úÖ NECESITA EXPOSICI√ìN GLOBAL.
     */
    async function updateUser(uid) {
    // 1. Obtener el ID corto para construir el ID del elemento SELECT
    const shortId = uid.substring(0, 8); 
    const select = document.getElementById(`roleSelect-${shortId}`); // Usar el guion (-) como en el HTML
    const newRole = select ? select.value : null;

    if (!newRole) {
        alert("Error: No se pudo determinar el nuevo rol.");
        return;
    }

    if (!confirm(`¬øEst√°s seguro de cambiar el rol del usuario ${shortId}... a ${newRole}?`)) {
        // Recargar para revertir el estado visual del select
        loadUsers(); 
        return;
    }
    
    try {
        const headers = getAuthHeaders();
        
        const response = await fetch(`${API_URL}/admin/usuarios/${uid}`, {
            method: 'PATCH',
            headers: { 
                ...headers, 
                'Content-Type': 'application/json' // CR√çTICO: Asegurar el Content-Type
            },
            // üö® USAR 'nuevorol' como clave, ya que tu c√≥digo anterior lo hac√≠a
            body: JSON.stringify({ nuevorol: newRole }) 
        });

        const data = await response.json();
        
        if (!response.ok) {
            // Maneja el error 400 del servidor
            throw new Error(data.mensaje || `Error ${response.status} al actualizar usuario`);
        }

        alert(`Rol de usuario actualizado exitosamente a: ${newRole}.`);
        loadUsers(); // Recargar la lista de usuarios para reflejar el cambio
        
    } catch (error) {
        console.error('Error al actualizar usuario:', error);
        alert(`‚ùå Fallo en la actualizaci√≥n: ${error.message}`);
        loadUsers(); // Recargar para revertir el estado visual en caso de error
    }
}

    /**
     * Funci√≥n que se llama desde onclick en la tabla de Usuarios.
     * ‚úÖ NECESITA EXPOSICI√ìN GLOBAL.
     */
    async function deleteUser(userId) {
        if (!confirm(`¬øEst√°s seguro de eliminar al usuario ${userId.substring(0, 8)}...? Esta acci√≥n es irreversible.`)) {
            return;
        }
        
        try {
            const headers = getAuthHeaders();
            const response = await fetch(`${API_URL}/admin/usuarios/${userId}`, {
                method: 'DELETE',
                headers: headers
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.mensaje || 'Error al eliminar usuario');
            }

            alert('Usuario eliminado correctamente.');
            loadUsers(); 
            
        } catch (error) {
            console.error('Error al eliminar usuario:', error);
            alert(`Fallo en la eliminaci√≥n: ${error.message}`);
        }
    }

    async function loadUsers() {
        usersList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Cargando usuarios...</li>';
        try {
            const headers = getAuthHeaders();
            if (!headers['Authorization']) {
                throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
            }

            const response = await fetch(`${API_URL}/admin/usuarios`, {
                headers: headers
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.usuarios) {
                throw new Error(data.mensaje || 'Error al cargar usuarios');
            }
            
            displayUsers(data.usuarios);
            
        } catch (error) {
            console.error('Error loading users:', error);
            usersList.innerHTML = `<li style="color: red; list-style: none;"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</li>`;
        }
    }


    // ===========================================
    // ‚úÖ EXPOSICI√ìN GLOBAL DE FUNCIONES (¬°CR√çTICO!)
    // ===========================================
    // Hacemos que todas las funciones llamadas directamente desde el HTML (con onclick, onchange) sean visibles.

    window.updateUser = updateUser;
    window.deleteUser = deleteUser; 
    window.deleteEvento = deleteEvento;
    // window.editEvento = editEvento; // Si la implementas, hazla global tambi√©n


    // ===============================================
    // 5. EVENT LISTENERS y L√ìGICA DE INICIO
    // ===============================================

    // Listener para el modal de Crear Evento
    document.getElementById('createEventoForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            titulo: document.getElementById('eventoTitulo').value,
            descripcion: document.getElementById('eventoDescripcion').value,
            fecha: document.getElementById('eventoFecha').value,
            hora: document.getElementById('eventoHora').value,
            ubicacion: document.getElementById('eventoUbicacion').value,
            activo: document.getElementById('eventoActivo').checked
        };
        
        // Objeto para IndexedDB (solo datos relevantes para la visualizaci√≥n local)
        const eventoDataForDB = { 
            id: 'temp-' + Date.now(), // ID temporal para IndexedDB (luego se actualizar√≠a con el ID real de la API)
            titulo: data.titulo, 
            fecha: data.fecha,
            ubicacion: data.ubicacion,
            descripcion: data.descripcion,
            activo: data.activo,
            timestamp: new Date().toISOString()
        };

        try {
            const headers = getAuthHeaders();
            if (!headers['Authorization']) {
                throw new Error("Fallo de Autenticaci√≥n: Token no disponible.");
            }

            // 1. Llamada a la API (Backend)
            const response = await fetch(`${API_URL}/admin/eventos`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                alert(`Error: ${result.mensaje}`);
                return;
            }

            // 2. L√≥gica de IndexedDB (Guardado local despu√©s del √©xito de la API)
            // Usamos el ID real de la API si est√° disponible, o el temporal.
            eventoDataForDB.id = result.id || eventoDataForDB.id; 
            await putItem(STORE_EVENTOS, eventoDataForDB); 
            console.log('Evento creado y guardado en IndexedDB con ID:', eventoDataForDB.id);

            alert('Evento creado exitosamente');
            document.getElementById('createEventoModal').style.display = 'none';
            document.getElementById('createEventoForm').reset();
            loadEventos();
            
        } catch (error) {
            console.error('Error creating evento:', error);
            alert('Error al crear evento: ' + error.message);
        }
    });

    // Listeners de la Interfaz de Usuario
    document.getElementById('refreshBtn')?.addEventListener('click', updateValidationUI);
    document.getElementById('loadUsersBtn')?.addEventListener('click', loadUsers);
    
    document.getElementById('createEventoBtn')?.addEventListener('click', () => {
        document.getElementById('createEventoModal').style.display = 'flex';
    });

    document.getElementById('closeEventoModal')?.addEventListener('click', () => {
        document.getElementById('createEventoModal').style.display = 'none';
        document.getElementById('createEventoForm').reset();
    });

    document.getElementById('showEventosBtn')?.addEventListener('click', () => {
        userManagementSection.style.display = 'none';
        eventoManagementSection.style.display = eventoManagementSection.style.display === 'none' ? 'block' : 'none';
        if (eventoManagementSection.style.display === 'block') {
            loadEventos();
        }
    });

    document.getElementById('loadUsersBtnAlt')?.addEventListener('click', () => {
        eventoManagementSection.style.display = 'none';
        userManagementSection.style.display = userManagementSection.style.display === 'none' ? 'block' : 'none';
        if (userManagementSection.style.display === 'block') {
            loadUsers();
        }
    });

    // L√≥gica de Cerrar Sesi√≥n
    document.getElementById("logoutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.clear();
        alert("Has cerrado sesi√≥n.");
        window.location.replace("login.html");
    });

    // Inicializar la lista, el mapa, Firebase y IndexedDB al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await openDB(); 
            console.log("IndexedDB abierta exitosamente.");
        } catch (error) {
            console.error("No se pudo abrir IndexedDB:", error);
        }

         if (isAllowed) {
            // [Existente] Carga UI de validaci√≥n
            updateValidationUI();
            
            // [NUEVO] Inicializar Mapa y Firebase
            initializeMap();
            const firebaseReady = await initializeFirebase();
            if (firebaseReady) {
                loadSensorData();
            }
         }
    });
</script>
</body>
</html>
