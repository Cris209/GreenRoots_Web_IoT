<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Gubernamental</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/base.css"> 
    <link rel="stylesheet" href="/header.css"> 
    <link rel="stylesheet" href="/dashboard.css"> 

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="module" src="/indexeddb-utils.js"></script>

    <script>
        // LÓGICA DE PROTECCIÓN DE RUTA
        function protectRoute(allowedRoles) {
            const userDataJSON = localStorage.getItem("usuario");
            const loginPage = "login.html";
            const homePage = "index.html"; 

            if (!userDataJSON) {
                window.location.replace(loginPage);
                return false;
            }

            const userData = JSON.parse(userDataJSON);
            const userRol = userData.rol?.trim(); 

            const userRolLower = userRol?.toLowerCase();
            const allowedRolesLower = allowedRoles.map(r => r.toLowerCase());
            
            if (!userRol || !allowedRolesLower.includes(userRolLower)) {
                alert("Acceso denegado. Solo el rol Gobierno tiene acceso a este panel.");
                window.location.replace(homePage);
                return false;
            }
            return true;
        }

        const isAllowed = protectRoute(['gobierno']);
        
        if (!isAllowed) {
            throw new Error("Acceso no autorizado. Redirección en curso."); 
        }
    </script>
    <style>
        /* =======================================================
           ESTILOS BASE Y PANELES (Ajustados para Gobierno)
           ======================================================= */
        :root {
            --primary-green: #386641;
            --accent-green: #6a994e;
            --light-green: #a7c957;
            --success-green: #2ecc71; 
            --warning-orange: #f39c12;
            --danger-red: #e74c3c;
            --white: #ffffff;
            --light-bg: #f5fcf8; 
            --text-dark: #333333;
            --text-light: #666666;
            --shadow: rgba(56, 102, 65, 0.08);
            --transition: all 0.3s ease;
        }
        
        body { font-family: 'Poppins', sans-serif; background-color: #e8f5f3; margin: 0; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
        .dashboard-panel { background: var(--white); border-radius: 20px; box-shadow: 0 10px 40px var(--shadow); }
        .panel-header { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary-green); }

        /* ESTILOS DE SENSORES Y MAPA */
        .sensor-data { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 1rem 1.5rem; }
        .data-card { text-align: center; padding: 15px 10px; border-radius: 10px; background-color: var(--light-bg); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .data-card i { font-size: 1.5rem; margin-bottom: 0.2rem; }
        .hum-card i { color: #4682b4; } 
        .lat-card i { color: #f39c12; } 
        .lon-card i { color: #c0392b; } 
        .data-value { display: block; font-size: 1.8rem; font-weight: 700; color: var(--text-dark); line-height: 1; overflow-wrap: break-word; word-break: break-all; }
        .data-unit { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; }
        
        #mapContainer { height: 350px; border-radius: 0 0 20px 20px; z-index: 1; }
        .map-panel { grid-column: span 1; }

        /* ESTILOS DEL FORMULARIO Y LISTA DE EVENTOS */
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .sensor-data { grid-template-columns: 1fr; padding: 1rem; }
        }
        @media (max-width: 1200px) {
             .dashboard-grid { grid-template-columns: 1fr; }
             .map-panel { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>Green Roots</h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="/dashboard.html" class="nav-link active">Dashboard</a></li>
                    <li id="gobiernoLink" style="display: none;"><a href="/gobierno.html" class="nav-link">Panel de Gobierno</a></li> 
                    <li><a href="/index.html" class="nav-link">Inicio</a></li>
                </ul>
                <div class="user-menu">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="userName">Voluntario</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Cerrar Sesión
                    </button>
                </div>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main class="dashboard-main">
        <div class="dashboard-container">
            <div class="welcome-section">
                <h1>¡Bienvenido a tu Dashboard! <span id="saludoNombre"></span></h1>
                <p>Gestiona tus actividades de reforestación y monitorea tu impacto ambiental</p>
            </div>
            
            <div class="dashboard-grid">
                
                <div class="dashboard-panel sensor-panel"> 
                    <div class="panel-header">
                        <h3><i class="fas fa-microchip"></i> Monitoreo del Sensor</h3>
                        <span id="estado-firebase" style="font-size: 0.8rem; color: var(--text-light);"><i class="fas fa-circle-notch fa-spin"></i> Inicializando...</span>
                    </div>
                    <div class="sensor-data">
                        <div class="data-card hum-card">
                            <i class="fas fa-tint"></i> <h4>Humedad</h4>
                            <span class="data-value" id="humedad-sensor">--</span>
                            <span class="data-unit">%</span>
                        </div>
                        <div class="data-card lat-card">
                            <i class="fas fa-map-marker-alt"></i> <h4>Latitud</h4>
                            <span class="data-value" id="latitud-sensor">--</span>
                            <span class="data-unit">°</span>
                        </div>
                        <div class="data-card lon-card">
                            <i class="fas fa-globe-americas"></i> <h4>Longitud</h4>
                            <span class="data-value" id="longitud-sensor">--</span>
                            <span class="data-unit">°</span>
                        </div>
                    </div>
                    <p style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text-light); padding-bottom: 1.5rem;">
                        Datos de GreenRoots RTDB. Última actualización: <span id="ultima-actualizacion">--</span>
                    </p>
                </div>
                
                <div class="dashboard-panel map-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-map-marked-alt"></i> Ubicación del Sensor</h3>
                    </div>
                    <div id="mapContainer"></div>
                </div>
                
                <div class="dashboard-panel chart-panel" style="grid-column: span 2;">
                    <div class="panel-header"><h3><i class="fas fa-chart-bar"></i> Distribución de Temperaturas</h3></div>
                    <div style="padding: 1.5rem;"><canvas id="temperatureChart" height="200"></canvas></div>
                </div>
                
                <div class="dashboard-panel chart-panel" style="grid-column: span 1;">
                    <div class="panel-header"><h3><i class="fas fa-chart-line"></i> Datos Históricos</h3></div>
                    <div style="padding: 1.5rem;"><canvas id="historicChart" height="200"></canvas></div>
                </div>

                <div class="dashboard-panel chart-panel" style="grid-column: span 1; padding: 1.5rem; align-self: flex-start;">
                    <h3 style="margin-bottom: 0;"><i class="fas fa-tasks"></i> Gestión de Eventos</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Crea y visualiza eventos para la comunidad.</p>
                    <button id="showEventosBtn" class="submit-btn" style="background: var(--light-green); margin-bottom: 10px; width: 100%; border: none; padding: 10px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-calendar"></i> Ver Eventos Creados
                    </button>
                    <button id="createEventoBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 10px; width: 100%; border: none; padding: 10px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-plus"></i> Crear Nuevo Evento
                    </button>
                </div>
                
                <div class="dashboard-panel chart-panel" style="grid-column: span 2; display: none;" id="eventoManagementSection">
                    <div class="panel-header">
                        <h3><i class="fas fa-calendar"></i> Lista de Eventos Creados</h3>
                    </div>
                    <div id="eventoList" style="padding: 1.5rem;">
                        <p style="text-align: center; color: var(--text-light);">Presiona "Ver Eventos Creados" para cargar la lista.</p>
                    </div>
                </div>
                
                </div>
        </div>
    </main>

    <div id="createEventoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Crear Nuevo Evento</h3>
            <form id="createEventoForm">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Nombre del Evento *</label>
                    <input type="text" id="eventoTitulo" required placeholder="Ej: Jornada de Reforestación Zona Norte" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Descripción *</label>
                    <textarea id="eventoDescripcion" required rows="3" placeholder="Describe el evento..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="margin-bottom: 15px; flex: 1;">
                        <label>Fecha del Evento</label>
                        <input type="date" id="eventoFecha" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px; flex: 1;">
                        <label>Hora del Evento</label>
                        <input type="time" id="eventoHora" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    </div>
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Ubicación</label>
                    <input type="text" id="eventoUbicacion" placeholder="Ej: Parque Central" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Estado</label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="eventoActivo" checked style="width: auto;">
                        <span>Evento Activo</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="submit-btn" style="background: var(--primary-green); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: 600;">
                        <i class="fas fa-save"></i> Crear
                    </button>
                    <button type="button" class="submit-btn" id="closeEventoModal" style="background: var(--danger-red); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: 600;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
        // =================================================================
        // Variables y Helpers de Autenticación
        // =================================================================
        const userData = localStorage.getItem("usuario") ? JSON.parse(localStorage.getItem("usuario")) : {};
        const API_URL = "https://greenroots-web.onrender.com/api"; // URL de la API de eventos

        /**
         * Genera los headers de autenticación (Authorization y X-User-Rol)
         */
        function getAuthHeaders() {
            const userToken = userData.token; 
            
            if (!userToken) {
                console.error("Token de autenticación no encontrado. Se requiere iniciar sesión.");
                // Retorna un objeto vacío, lo que causará un error 401 en fetch
                return {}; 
            }

            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`, 
                // Asumimos que el Gobierno usa su rol 'Gobierno' para el endpoint
                'X-User-Rol': userData.rol || 'Gobierno' 
            };
        }


        // =================================================================
        // LÓGICA DE MAPA Y FIREBASE (Existente)
        // =================================================================
        let map;
        let currentMarker = null;
        let firebaseApp;
        let db;
        
        const DEFAULT_LAT = 19.4326; 
        const DEFAULT_LON = -99.1332;

        function initializeMap() {
            if (document.getElementById('mapContainer')) {
                map = L.map('mapContainer').setView([DEFAULT_LAT, DEFAULT_LON], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }

        async function initializeFirebase() {
            const estadoElement = document.getElementById('estado-firebase');
            if (!userData) { estadoElement.textContent = "Usuario no autenticado."; return false; }

            try {
                const firebaseConfig = { databaseURL: "https://greenroot-6dbfe-default-rtdb.firebaseio.com/" };
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.database(); 
                estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Conectado al RTDB.`;
                return true;
            } catch (error) { 
                estadoElement.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger-red);"></i> ERROR: ${error.message.split(":")[0] || "No se pudo conectar"}`;
                return false;
            }
        }
        
        function loadSensorData() {
            // Lógica de carga de datos del sensor de Firebase... (mantenida del código anterior)
            if (!db) return;
            const greenrootsRef = db.ref('greenroots'); 
            const humElement = document.getElementById('humedad-sensor');
            const latElement = document.getElementById('latitud-sensor');
            const lonElement = document.getElementById('longitud-sensor');
            const estadoElement = document.getElementById('estado-firebase');
            const ultimaActElement = document.getElementById('ultima-actualizacion');
            
            greenrootsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const humedad = data.humedad !== undefined ? parseFloat(data.humedad).toFixed(1) : '--';
                    const latitud = data.latitud !== undefined ? parseFloat(data.latitud) : null;
                    const longitud = data.longitud !== undefined ? parseFloat(data.longitud) : null;
                    humElement.textContent = humedad;
                    latElement.textContent = latitud !== null ? latitud.toFixed(6) : '--';
                    lonElement.textContent = longitud !== null ? longitud.toFixed(6) : '--';

                    if (map && latitud !== null && longitud !== null) {
                        const newLatLng = new L.LatLng(latitud, longitud);
                        if (currentMarker) currentMarker.setLatLng(newLatLng);
                        else currentMarker = L.marker(newLatLng).addTo(map).bindPopup('Sensor GreenRoots').openPopup();
                        if (!map.getBounds().contains(newLatLng)) map.setView(newLatLng, 13);
                    }
                    estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Monitoreando RTDB.`;
                    ultimaActElement.textContent = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
                } else {
                    // ... manejo de datos vacíos ...
                }
            }, (error) => {
                // ... manejo de errores ...
            });
        }
        
        // =================================================================
        // NUEVO: LÓGICA DE GESTIÓN DE EVENTOS (Adaptada de admin_panel.html)
        // =================================================================

        /**
         * Carga los eventos de la API y los muestra.
         */
        async function loadEventos() {
            const eventoList = document.getElementById('eventoList');
            eventoList.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Cargando eventos...</p>';
            
            try {
                const headers = getAuthHeaders();
                if (!headers['Authorization']) { throw new Error("Fallo de Autenticación: Token no disponible."); }

                const response = await fetch(`${API_URL}/admin/eventos`, {
                    headers: headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.mensaje || 'Error al cargar eventos');
                }
                
                displayEventos(data.eventos || []);
                
            } catch (error) {
                console.error('Error loading eventos:', error);
                eventoList.innerHTML = `<p style="color: var(--danger-red); text-align: center;"><i class="fas fa-exclamation-circle"></i> Error al cargar eventos: ${error.message}</p>`;
            }
        }

        /**
         * Renderiza la lista de eventos en el DOM.
         */
        function displayEventos(eventos) {
            const eventoList = document.getElementById('eventoList');
            eventoList.innerHTML = '';
            
            if (eventos.length === 0) {
                eventoList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No hay eventos creados.</p>';
                return;
            }
            
            eventos.forEach(evento => {
                const eventoItem = document.createElement('div');
                eventoItem.style.cssText = 'background: var(--light-bg); padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid var(--primary-green); box-shadow: 0 2px 5px rgba(0,0,0,0.05);';
                
                const fechaEvento = evento.fecha ? new Date(evento.fecha).toLocaleDateString('es-ES') : 'N/A';
                const horaEvento = evento.hora || 'No especificada';
                
                eventoItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; color: var(--text-dark);">
                                ${evento.titulo} 
                                <span style="background: ${evento.activo ? 'var(--success-green)' : 'gray'}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; font-weight: normal;">
                                    ${evento.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </h4>
                            <p style="margin: 0 0 10px 0; color: var(--text-light); font-size: 0.9rem;">${evento.descripcion}</p>
                            <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-size: 0.85rem;">
                                <i class="fas fa-calendar"></i> Fecha: ${fechaEvento} | 
                                <i class="fas fa-clock"></i> Hora: ${horaEvento}
                            </small>
                            <small style="color: #4682b4; display: block; font-size: 0.85rem;">
                                <i class="fas fa-map-marker-alt"></i> ${evento.ubicacion || 'No especificada'}
                            </small>
                        </div>
                        <div>
                            <button onclick="deleteEvento('${evento.id}')" style="background: var(--danger-red); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                eventoList.appendChild(eventoItem);
            });
        }
        
        /**
         * Elimina un evento. Se hace global para ser llamado desde el HTML.
         */
        async function deleteEvento(id) {
            if (!confirm('¿Seguro que deseas eliminar este evento?')) return;
            
            try {
                const headers = getAuthHeaders();
                if (!headers['Authorization']) { throw new Error("Fallo de Autenticación."); }

                const response = await fetch(`${API_URL}/admin/eventos/${id}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(`Error al eliminar: ${data.mensaje}`);
                    return;
                }
                
                alert('Evento eliminado exitosamente.');
                loadEventos();
                
            } catch (error) {
                console.error('Error deleting evento:', error);
                alert('Error al eliminar evento');
            }
        }
        window.deleteEvento = deleteEvento; // Hacer accesible globalmente

        // -----------------------------------------------------------------
        // LÓGICA DE GRÁFICAS Y ARRANQUE
        // -----------------------------------------------------------------

        function initializeCharts() {
            // Lógica de inicialización de gráficas... (mantenida del código anterior)
            if (document.getElementById('temperatureChart')) {
                const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(temperatureCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-10°C', '11-20°C', '21-30°C', '31-40°C'],
                        datasets: [{ label: 'Frecuencia de Lecturas', data: [15, 60, 110, 25], backgroundColor: ['rgba(52, 152, 219, 0.8)', 'rgba(46, 204, 113, 0.8)', 'rgba(243, 156, 18, 0.8)', 'rgba(231, 76, 60, 0.8)'], borderRadius: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
                });
            }
            if (document.getElementById('historicChart')) {
                const historicCtx = document.getElementById('historicChart').getContext('2d');
                new Chart(historicCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov'],
                        datasets: [{ label: 'Humedad Promedio', data: [45, 55, 62, 58, 50, 48], borderColor: 'rgba(56, 102, 65, 1)', backgroundColor: 'rgba(56, 102, 65, 0.2)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false, max: 100 }, x: { } } }
                });
            }
        }

        function logout() {
            localStorage.clear();
            alert("Has cerrado sesión.");
            window.location.replace("login.html");
        }
        window.logout = logout; 

        // Inicializar todo al cargar el documento (Lógica principal)
        document.addEventListener('DOMContentLoaded', async () => {
             initializeCharts(); 

             if (isAllowed) {
                initializeMap();
                const firebaseReady = await initializeFirebase();
                if (firebaseReady) {
                    loadSensorData();
                }
                

                // NUEVO: Listeners para Gestión de Eventos

                // Mostrar/Ocultar lista de eventos
                document.getElementById('showEventosBtn')?.addEventListener('click', () => {
                    const section = document.getElementById('eventoManagementSection');
                    const isVisible = section.style.display === 'block';
                    section.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        loadEventos(); // Cargar la lista al mostrar
                    }
                });
                
                // Mostrar modal de creación
                document.getElementById('createEventoBtn')?.addEventListener('click', () => {
                    document.getElementById('createEventoModal').style.display = 'flex';
                });
                
                // Cerrar modal
                document.getElementById('closeEventoModal')?.addEventListener('click', () => {
                    document.getElementById('createEventoModal').style.display = 'none';
                    document.getElementById('createEventoForm').reset();
                });
                
                // Enviar formulario de creación
                document.getElementById('createEventoForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const data = {
                        titulo: document.getElementById('eventoTitulo').value,
                        descripcion: document.getElementById('eventoDescripcion').value,
                        fecha: document.getElementById('eventoFecha').value,
                        hora: document.getElementById('eventoHora').value,
                        ubicacion: document.getElementById('eventoUbicacion').value,
                        activo: document.getElementById('eventoActivo').checked
                    };

                    try {
                        const headers = getAuthHeaders();
                        if (!headers['Authorization']) { throw new Error("Fallo de Autenticación."); }

                        const response = await fetch(`${API_URL}/admin/eventos`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(data)
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            alert(`Error al crear evento: ${result.mensaje}`);
                            return;
                        }
                        
                        alert('Evento creado exitosamente.');
                        document.getElementById('createEventoModal').style.display = 'none';
                        document.getElementById('createEventoForm').reset();
                        
                        // Si la sección de eventos está visible, recargar la lista
                        if (document.getElementById('eventoManagementSection').style.display === 'block') {
                            loadEventos();
                        }
                        
                    } catch (error) {
                        console.error('Error creating evento:', error);
                        alert('Error al crear evento. Revise la consola y la conexión de la API.');
                    }
                });
             }
        });
    </script>
</body>
</html>
