<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Gubernamental</title>

    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/base.css"> 
    <link rel="stylesheet" href="/header.css"> 
    <link rel="stylesheet" href="/dashboard.css"> 

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="module" src="/indexeddb-utils.js"></script>

    <script>
        // LGICA DE PROTECCIN DE RUTA
        function protectRoute(allowedRoles) {
            const userDataJSON = localStorage.getItem("usuario");
            const loginPage = "login.html";
            const homePage = "index.html"; 

            if (!userDataJSON) {
                window.location.replace(loginPage);
                return false;
            }

            const userData = JSON.parse(userDataJSON);
            const userRol = userData.rol?.trim(); 

            const userRolLower = userRol?.toLowerCase();
            const allowedRolesLower = allowedRoles.map(r => r.toLowerCase());
            
            if (!userRol || !allowedRolesLower.includes(userRolLower)) {
                alert("Acceso denegado. Solo el rol Gobierno tiene acceso a este panel.");
                window.location.replace(homePage);
                return false;
            }
            return true;
        }

        const isAllowed = protectRoute(['gobierno']);
        
        if (!isAllowed) {
            throw new Error("Acceso no autorizado. Redirecci贸n en curso."); 
        }
    </script>
    <style>
        /* =======================================================
           ESTILOS BASE Y PANELES (Ajustados para Gobierno)
           ======================================================= */
        :root {
            --primary-green: #386641;
            --accent-green: #6a994e;
            --light-green: #a7c957;
            --success-green: #2ecc71; 
            --warning-orange: #f39c12;
            --danger-red: #e74c3c;
            --white: #ffffff;
            --light-bg: #f5fcf8; 
            --text-dark: #333333;
            --text-light: #666666;
            --shadow: rgba(56, 102, 65, 0.08);
            --transition: all 0.3s ease;
        }
        
        body { font-family: 'Poppins', sans-serif; background-color: #e8f5f3; margin: 0; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
        .dashboard-panel { background: var(--white); border-radius: 20px; box-shadow: 0 10px 40px var(--shadow); }
        .panel-header { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 1.2rem; font-weight: 600; color: var(--primary-green); }

        /* ESTILOS DE SENSORES Y MAPA */
        .sensor-data { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 1rem 1.5rem; }
        .data-card { text-align: center; padding: 15px 10px; border-radius: 10px; background-color: var(--light-bg); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .data-card i { font-size: 1.5rem; margin-bottom: 0.2rem; }
        .hum-card i { color: #4682b4; } 
        .lat-card i { color: #f39c12; } 
        .lon-card i { color: #c0392b; } 
        .data-value { display: block; font-size: 1.8rem; font-weight: 700; color: var(--text-dark); line-height: 1; overflow-wrap: break-word; word-break: break-all; }
        .data-unit { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; }
        
        #mapContainer { height: 350px; border-radius: 0 0 20px 20px; z-index: 1; }
        .map-panel { grid-column: span 1; }

        /* ESTILOS DEL FORMULARIO Y LISTA DE EVENTOS */
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .notificacion-humedad {
    padding: 10px 15px;
    border-radius: 10px; /* Consistente con otros elementos del dashboard */
    font-weight: 600;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 90%; 
    max-width: 400px;
    margin: 0 auto; /* Para centrar la notificaci贸n */
    font-size: 0.95rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra suave */
}

.notificacion-humedad i {
    font-size: 1.2rem;
}

/* Clases de Estado basadas en base.css */
/* XITO: Humedad 20% a 50% */
.status-success {
    background-color: var(--light-green); 
    color: var(--primary-green); 
    border: 1px solid var(--accent-green);
}

/* ADVERTENCIA: Humedad < 20% (Necesita agua) */
.status-warning {
    background-color: #fff3cd; /* Amarillo suave */
    color: var(--warning-orange); 
    border: 1px solid var(--warning-orange);
}

/* PELIGRO: Humedad > 50% (Se est谩 ahogando) */
.status-danger {
    background-color: #f8d7da; /* Rojo suave */
    color: var(--danger-red); 
    border: 1px solid var(--danger-red);
}


        /* Responsive Design */
        @media (max-width: 600px) {
            .sensor-data { grid-template-columns: 1fr; padding: 1rem; }
        }
        @media (max-width: 1200px) {
             .dashboard-grid { grid-template-columns: 1fr; }
             .map-panel { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <i class="fas fa-seedling"></i>
                    <h1>Green Roots</h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="/dashboard.html" class="nav-link active">Dashboard</a></li>
                    <li id="gobiernoLink" style="display: none;"><a href="/gobierno.html" class="nav-link">Panel de Gobierno</a></li> 
                    <li><a href="/index.html" class="nav-link">Inicio</a></li>
                </ul>
                <div class="user-menu">
                    <div class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span id="userName">Gobierno</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Cerrar Sesi贸n
                    </button>
                </div>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <main class="dashboard-main">
        <div class="dashboard-container">
            <div class="welcome-section">
                <h1>隆Bienvenido a tu Dashboard! <span id="saludoNombre"></span></h1>
                <p>Gestiona tus actividades de reforestaci贸n y monitorea tu impacto ambiental</p>
            </div>
            
            <div class="dashboard-grid">
                <button id="exportReportBtn" class="btn btn-primary">
    <i class="fas fa-file-excel"></i> Exportar Reporte CSV
</button>
                <div class="dashboard-panel sensor-panel"> 
                    <div class="panel-header">
                        <h3><i class="fas fa-microchip"></i> Monitoreo del Sensor</h3>
                        <span id="estado-firebase" style="font-size: 0.8rem; color: var(--text-light);"><i class="fas fa-circle-notch fa-spin"></i> Inicializando...</span>
                    </div>
                    <div class="sensor-data">
                        <div class="data-card hum-card">
                            <i class="fas fa-tint"></i> <h4>Humedad</h4>
                            <span class="data-value" id="humedad-sensor">--</span>
                            <span class="data-unit">%</span>
                        </div>
                        <div class="data-card lat-card">
                            <i class="fas fa-map-marker-alt"></i> <h4>Latitud</h4>
                            <span class="data-value" id="latitud-sensor">--</span>
                            <span class="data-unit">掳</span>
                        </div>
                        <div class="data-card lon-card">
                            <i class="fas fa-globe-americas"></i> <h4>Longitud</h4>
                            <span class="data-value" id="longitud-sensor">--</span>
                            <span class="data-unit">掳</span>
                        </div>
                    </div>
                     <p style="text-align: center; margin-top: 10px; font-size: 0.85rem; color: var(--text-light);">Datos de GreenRoots RTDB. Actualizaci贸n: <span id="ultima-actualizacion">--</span></p>
                    
                    <div id="humedad-notificacion" class="notificacion-humedad" style="display: none; margin-top: 15px;">
                        <i class="fas fa-spinner fa-pulse"></i> Cargando estado...
                    </div>
                </div>
                
                <div class="dashboard-panel map-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-map-marked-alt"></i> Ubicaci贸n del Sensor</h3>
                    </div>
                    <div id="mapContainer"></div>
                </div>
                
                <div class="dashboard-panel chart-panel" style="grid-column: span 1;">
                    <div class="panel-header"><h3><i class="fas fa-chart-line"></i> Datos Hist贸ricos</h3></div>
                    <div style="padding: 1.5rem;"><canvas id="historicoArbolesChart" height="200"></canvas></div>
                </div>

                <div class="dashboard-panel chart-panel" style="grid-column: span 1; padding: 1.5rem; align-self: flex-start;">
                    <h3 style="margin-bottom: 0;"><i class="fas fa-tasks"></i> Gesti贸n de Eventos</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Crea y visualiza eventos para la comunidad.</p>
                    <button id="showEventosBtn" class="submit-btn" style="background: var(--light-green); margin-bottom: 10px; width: 100%; border: none; padding: 10px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-calendar"></i> Ver Eventos Creados
                    </button>
                    <button id="createEventoBtn" class="submit-btn" style="background: var(--primary-green); margin-bottom: 10px; width: 100%; border: none; padding: 10px; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-plus"></i> Crear Nuevo Evento
                    </button>
                </div>
                
                <div class="dashboard-panel chart-panel" style="grid-column: span 2; display: none;" id="eventoManagementSection">
                    <div class="panel-header">
                        <h3><i class="fas fa-calendar"></i> Lista de Eventos Creados</h3>
                    </div>
                     <div class="activities-list" id="eventosContainer">
                        <p style="padding: 1.5rem;"><i class="fas fa-spinner fa-spin"></i> Cargando eventos...</p>
                    </div>
                </div>
                
                </div>
        </div>
    </main>

    <div id="createEventoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Crear Nuevo Evento</h3>
            <form id="createEventoForm">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Nombre del Evento *</label>
                    <input type="text" id="eventoTitulo" required placeholder="Ej: Jornada de Reforestaci贸n Zona Norte" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Descripci贸n *</label>
                    <textarea id="eventoDescripcion" required rows="3" placeholder="Describe el evento..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                </div>
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="margin-bottom: 15px; flex: 1;">
                        <label>Fecha del Evento</label>
                        <input type="date" id="eventoFecha" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    </div>
                    <div class="input-group" style="margin-bottom: 15px; flex: 1;">
                        <label>Hora del Evento</label>
                        <input type="time" id="eventoHora" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                    </div>
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Ubicaci贸n</label>
                    <input type="text" id="eventoUbicacion" placeholder="Ej: Parque Central" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label>Estado</label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="eventoActivo" checked style="width: auto;">
                        <span>Evento Activo</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="submit-btn" style="background: var(--primary-green); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: 600;">
                        <i class="fas fa-save"></i> Crear
                    </button>
                    <button type="button" class="submit-btn" id="closeEventoModal" style="background: var(--danger-red); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: 600;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
    // =================================================================
    // Variables y Helpers de Autenticaci贸n (CORREGIDO)
    // =================================================================
    // Nota: El 'token' debe estar en localStorage, no en userData si se usa
    // para las llamadas fetch. Usaremos localStorage.getItem('token') directamente.
    const userDataJSON = localStorage.getItem("usuario");
    const userData = userDataJSON ? JSON.parse(userDataJSON) : {};
    
    // Su URL de API real
    const API_URL = "https://greenroots-web.onrender.com/api"; 

    /**
     * Genera los headers de autenticaci贸n (Authorization y X-User-Rol)
     */
    function getAuthHeaders() {
    // Intenta obtener la informaci贸n completa del usuario del localStorage
    const userDataJSON = localStorage.getItem('usuario');
    
    if (!userDataJSON) {
        // Si no hay datos, retorna encabezados vac铆os. El backend devolver谩 401.
        return {};
    }

    const userData = JSON.parse(userDataJSON);
    
    //  CLAVE: El token est谩 dentro del objeto de usuario bajo la clave 'token'
    const authToken = userData.token; 
    
    // Si tienes informaci贸n de rol que el backend requiere (opcional, pero buena pr谩ctica)
    const userRol = userData.rol;

    const headers = {
        // Es una buena pr谩ctica incluir Content-Type
        'Content-Type': 'application/json' 
    };

    if (authToken) {
        // Formato est谩ndar 'Bearer Token' para autenticaci贸n
        headers['Authorization'] = `Bearer ${authToken}`; 
    }
    
    if (userRol) {
        headers['X-User-Rol'] = userRol; 
    }

    return headers;
}


    // =================================================================
    // LGICA DE MAPA Y FIREBASE (Existente)
    // =================================================================
    let map;
    let currentMarker = null;
    let firebaseApp;
    let db;
    let historicoChartInstance = null;

    const DEFAULT_LAT = 19.4326; 
    const DEFAULT_LON = -99.1332;

    function initializeMap() {
        if (document.getElementById('mapContainer')) {
            map = L.map('mapContainer').setView([DEFAULT_LAT, DEFAULT_LON], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }
    }

    async function initializeFirebase() {
        const estadoElement = document.getElementById('estado-firebase');
        if (!userDataJSON) { estadoElement.textContent = "Usuario no autenticado."; return false; }

        try {
            const firebaseConfig = { databaseURL: "https://greenroot-6dbfe-default-rtdb.firebaseio.com/" };
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database(); 
            estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Conectado al RTDB.`;
            return true;
        } catch (error) { 
            estadoElement.innerHTML = `<i class="fas fa-times-circle" style="color: var(--danger-red);"></i> ERROR: ${error.message.split(":")[0] || "No se pudo conectar"}`;
            return false;
        }
    }

    function updateHumedadNotification(humedad) {
        const notificacionElement = document.getElementById('humedad-notificacion');
        if (!notificacionElement) return;

        notificacionElement.style.display = 'flex'; // Mostrar el elemento

        let mensaje = '';
        let claseStatus = '';
        let icono = '';
        
        const humDisplay = humedad.toFixed(0);

        // L贸gica de umbrales solicitada
        if (humedad > 50) {
            // > 50%: Se est谩 ahogando (PELIGRO)
            mensaje = `隆ALERTA! La planta **se est谩 ahogando** (${humDisplay}%).`;
            claseStatus = 'status-danger';
            icono = 'fas fa-exclamation-triangle';
        } else if (humedad >= 20 && humedad <= 50) {
            // 20% - 50%: Est谩 bien de agua (XITO)
            mensaje = `La planta **est谩 bien de agua** (${humDisplay}%).`;
            claseStatus = 'status-success';
            icono = 'fas fa-check-circle';
        } else { // Humedad < 20
            // < 20%: Necesita agua (ADVERTENCIA)
            mensaje = `La planta **necesita agua** (${humDisplay}%).`;
            claseStatus = 'status-warning';
            icono = 'fas fa-hand-holding-water';
        }
        
        notificacionElement.innerHTML = `<i class="${icono}"></i> ${mensaje}`;
        // Asigna la clase de estado actual
        notificacionElement.className = 'notificacion-humedad ' + claseStatus; 
    }
    
    function loadSensorData() {
        // L贸gica de carga de datos del sensor de Firebase... (mantenida del c贸digo anterior)
        if (!db) return;
        const greenrootsRef = db.ref('greenroots'); 
        const humElement = document.getElementById('humedad-sensor');
        const latElement = document.getElementById('latitud-sensor');
        const lonElement = document.getElementById('longitud-sensor');
        const estadoElement = document.getElementById('estado-firebase');
        const ultimaActElement = document.getElementById('ultima-actualizacion');
        const notifElement = document.getElementById('humedad-notificacion'); // Definir el elemento de notificaci贸n

        greenrootsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const humedad = data.humedad !== undefined ? parseFloat(data.humedad).toFixed(1) : null;
                const humedadNum = humedad !== null ? parseFloat(humedad) : null; // 猬锔 CORRECCIN DE ERROR
                const latitud = data.latitud !== undefined ? parseFloat(data.latitud) : null;
                const longitud = data.longitud !== undefined ? parseFloat(data.longitud) : null;
                
                humElement.textContent = humedad !== null ? humedad : '--';
                latElement.textContent = latitud !== null ? latitud.toFixed(6) : '--';
                lonElement.textContent = longitud !== null ? longitud.toFixed(6) : '--';
                
                if (humedadNum !== null) {
                    updateHumedadNotification(humedadNum); 
                } else if (notifElement) {
                    // Si hay datos pero la humedad es nula, mostrar mensaje de dato faltante
                    notifElement.className = 'notificacion-humedad status-warning'; 
                    notifElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Dato de humedad no disponible.';
                    notifElement.style.display = 'flex';
                }
                
                if (map && latitud !== null && longitud !== null) {
                    const newLatLng = new L.LatLng(latitud, longitud);
                    if (currentMarker) currentMarker.setLatLng(newLatLng);
                    else currentMarker = L.marker(newLatLng).addTo(map).bindPopup('Sensor GreenRoots').openPopup();
                    if (!map.getBounds().contains(newLatLng)) map.setView(newLatLng, 13);
                }
                estadoElement.innerHTML = `<i class="fas fa-check-circle" style="color: var(--primary-green);"></i> Monitoreando RTDB.`;
                ultimaActElement.textContent = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
            } else {
                // ... manejo de datos vac铆os ...
            }
        }, (error) => {
            // ... manejo de errores ...
        });
    }
    
    // =================================================================
    // LGICA DE GESTIN DE EVENTOS (Adaptada de admin_panel.html)
    // =================================================================

    /**
    * Carga TODOS los eventos (web y m贸vil) de la API.
    * Endpoint: GET /api/eventos/activos
    */
    async function loadEventos() {
    const eventosContainer = document.getElementById('eventosContainer');
    eventosContainer.innerHTML = '<p style="padding: 1.5rem;"><i class="fas fa-spinner fa-spin"></i> Cargando eventos...</p>';
    
    // 1. Obtener datos de usuario y token
    const token = userData?.token; 
    const voluntarioId = userData?.id; // ID del usuario autenticado (necesario para verificar si est谩 unido)
    
    if (!userData || !token || !voluntarioId) {
        eventosContainer.innerHTML = '<p style="color: var(--danger-red); padding: 1.5rem;"><i class="fas fa-user-lock"></i> No autenticado. Inicia sesi贸n para ver las actividades.</p>';
        return;
    }

    try {
        // 2. Realizar la solicitud incluyendo el token de autorizaci贸n
        const headers = getAuthHeaders(); // Funci贸n que a帽ade el token al header
        // Usamos la ruta gen茅rica /api/eventos (asumiendo que devuelve activos o la ajustas en tu backend)
        // Si la ruta /eventos/activos no requiere auth, quita 'headers' del fetch
        const response = await fetch(`${API_URL}/eventos/activos`, {
            method: 'GET',
            headers: headers, // A帽adimos el header de autenticaci贸n
        });
        
        const data = await response.json();

        if (!response.ok) {
            eventosContainer.innerHTML = `<p style="color: var(--danger-red); padding: 1.5rem;"><i class="fas fa-exclamation-circle"></i> Error ${response.status}: ${data.mensaje || 'Error al cargar eventos.'}</p>`;
            return;
        }
        
        const eventos = data.eventos || [];
        
        // 3. Actualizar contador en la tarjeta
    
        
        eventosContainer.innerHTML = '';
        
        // 4. Renderizar eventos y manejar el estado de participaci贸n
        eventos.slice(0, 5).forEach(evento => { 
    const fechaObj = new Date(evento.fecha);
    const esFechaValida = !isNaN(fechaObj.getTime());
    
    let dia, mes;

    if (esFechaValida) {
        dia = fechaObj.getDate().toString().padStart(2, '0');
        mes = fechaObj.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
    } else {
        dia = '??';
        mes = 'FECHA';
    }
    
    const eventoItem = document.createElement('div');
    eventoItem.className = 'activity-item';
    eventoItem.innerHTML = `
        <div class="activity-date">
            <span class="day">${dia}</span>
            <span class="month">${mes}</span>
        </div>
        <div class="activity-info">
            <h4>${evento.titulo}</h4>
            <p><i class="fas fa-map-marker-alt"></i> ${evento.ubicacion || 'Ubicaci贸n pendiente'}</p>
            <p><i class="fas fa-clock"></i> ${evento.hora || 'Hora pendiente'}</p>
            <p><i class="fas fa-users"></i> ${evento.participantes.length} participantes</p>
        </div>
    `;
    eventosContainer.appendChild(eventoItem);
});

    } catch (error) {
        console.error("Error al obtener eventos:", error);
        eventosContainer.innerHTML = '<p style="color: var(--danger-red); padding: 1.5rem;"><i class="fas fa-exclamation-circle"></i> Error de conexi贸n con el servidor.</p>';
    }
}
    
    /**
     * Elimina un evento. Se hace global para ser llamado desde el HTML.
     */
    async function deleteEvento(id) {
        if (!confirm('驴Seguro que deseas eliminar este evento?')) return;
        
        try {
            const headers = getAuthHeaders(); // 猬锔 CORRECCIN: Se llama a getAuthHeaders()
            if (!headers['Authorization']) { throw new Error("Fallo de Autenticaci贸n."); }

            const response = await fetch(`${API_URL}/admin/eventos/${id}`, {
                method: 'DELETE',
                headers: headers
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                alert(`Error al eliminar: ${data.mensaje}`);
                return;
            }
            
            alert('Evento eliminado exitosamente.');
            loadEventos();
            
        } catch (error) {
            console.error('Error deleting evento:', error);
            alert('Error al eliminar evento');
        }
    }
    window.deleteEvento = deleteEvento; // Hacer accesible globalmente

    // -----------------------------------------------------------------
    // LGICA DE GRFICAS Y ARRANQUE
    // -----------------------------------------------------------------

    function initializeCharts() {
        // L贸gica de inicializaci贸n de gr谩ficas... (mantenida del c贸digo anterior)
        if (document.getElementById('temperatureChart')) {
            const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
            new Chart(temperatureCtx, {
                type: 'bar',
                data: {
                    labels: ['0-10掳C', '11-20掳C', '21-30掳C', '31-40掳C'],
                    datasets: [{ label: 'Frecuencia de Lecturas', data: [15, 60, 110, 25], backgroundColor: ['rgba(52, 152, 219, 0.8)', 'rgba(46, 204, 113, 0.8)', 'rgba(243, 156, 18, 0.8)', 'rgba(231, 76, 60, 0.8)'], borderRadius: 5 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }
        if (document.getElementById('historicChart')) {
            const historicCtx = document.getElementById('historicChart').getContext('2d');
            new Chart(historicCtx, {
                type: 'line',
                data: {
                    labels: ['Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov'],
                    datasets: [{ label: 'Humedad Promedio', data: [45, 55, 62, 58, 50, 48], borderColor: 'rgba(56, 102, 65, 1)', backgroundColor: 'rgba(56, 102, 65, 0.2)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false, max: 100 }, x: { } } }
            });
        }
    }

    /**
 * Carga y grafica el hist贸rico de 谩rboles registrados.
 */
async function cargarHistoricoArboles() {
    try {
        const headers = getAuthHeaders(); // Se asume que getAuthHeaders() ya existe y retorna { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }

        if (!headers['Authorization']) {
            console.error("Fallo de Autenticaci贸n: Token no encontrado.");
            return;
        }

        // 1. Llamar al nuevo endpoint
        const response = await fetch(`${API_URL}/arboles/historico`, {
            method: 'GET',
            headers: headers
        });

        const result = await response.json();

        if (!response.ok || !result.ok) {
            console.error('Error al cargar hist贸rico de 谩rboles:', result.mensaje || 'Error desconocido');
            return;
        }

        const arboles = result.arboles;

        // 2. Procesar los datos: Contar 谩rboles por mes/a帽o de registro
        const datosPorMes = arboles.reduce((acc, arbol) => {
            // Usa 'fechaRegistro' o el campo que est茅s usando. Convierte a objeto Date.
            const fecha = new Date(arbol.fechaRegistro);
            // Formato 'YYYY-MM' para ordenar f谩cilmente
            const mesAnio = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;

            acc[mesAnio] = (acc[mesAnio] || 0) + 1;
            return acc;
        }, {});

        // 3. Preparar datos para Chart.js
        const labels = Object.keys(datosPorMes).sort(); // Ordenar cronol贸gicamente
        const dataPorMes = labels.map(mesAnio => datosPorMes[mesAnio]);

        // Calcular el acumulado
        let acumulado = 0;
        const datosAcumulados = dataPorMes.map(conteo => {
            acumulado += conteo;
            return acumulado;
        });
        
        // 4. Renderizar el gr谩fico
        const ctx = document.getElementById('historicoArbolesChart').getContext('2d');

        // Destruir la instancia anterior si existe (importante para refrescar)
        if (historicoChartInstance) {
            historicoChartInstance.destroy();
        }

        historicoChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                // Etiqueta legible para cada punto (ej: Nov 2023)
                labels: labels.map(label => {
                    const [year, month] = label.split('-');
                    return new Date(year, month - 1).toLocaleString('es-ES', { month: 'short', year: 'numeric' });
                }),
                datasets: [{
                    label: 'rboles Registrados (Acumulado)',
                    data: datosAcumulados,
                    borderColor: 'rgb(34, 139, 34)', // Verde
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(34, 139, 34, 0.2)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Crecimiento Hist贸rico de rboles Registrados'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total de rboles'
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Error general al cargar el hist贸rico de 谩rboles:', error);
    }
}

/**
 * Transforma un array de objetos JSON a una cadena de texto en formato CSV.
 * @param {Array<Object>} data - Los datos a exportar.
 * @param {string} title - T铆tulo de la secci贸n para el CSV.
 */
function convertToCSV(data, title) {
    if (data.length === 0) {
        return `"${title} (Sin Datos)"\n\n`;
    }

    // 1. Obtener los encabezados (keys del primer objeto)
    const headers = Object.keys(data[0]);
    
    // 2. Crear la fila de encabezados
    let csv = `"${title}"\n`; // T铆tulo de la secci贸n
    csv += headers.map(key => `"${key}"`).join(',') + '\n'; // Encabezados entre comillas

    // 3. Iterar sobre los datos para crear las filas
    data.forEach(item => {
        let row = headers.map(key => {
            let value = item[key] !== undefined && item[key] !== null ? item[key] : '';
            
            // Convertir objetos o arrays a string JSON si es necesario
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value);
            }

            // Limpieza y manejo de comillas: encapsular y escapar comillas dobles
            value = String(value).replace(/"/g, '""'); 
            
            return `"${value}"`;
        }).join(',');
        csv += row + '\n';
    });

    return csv + '\n'; // Separador de secci贸n
}

/**
 * L贸gica principal para obtener los datos consolidados y descargar el archivo CSV.
 */
async function exportarReporteCompleto() {
    try {
        const headers = getAuthHeaders(); // Se asume que getAuthHeaders() existe

        if (!headers['Authorization']) {
            alert("Error: Token de autenticaci贸n no encontrado.");
            return;
        }

        // 1. Llamar al nuevo endpoint
        const response = await fetch(`${API_URL}/reporte/completo`, { 
            method: 'GET',
            headers: headers
        });

        const result = await response.json();

        if (!response.ok || !result.ok) {
            throw new Error(result.mensaje || 'Error desconocido al obtener los datos para el reporte.');
        }

        const { arboles, sensores, eventos } = result;

        // 2. Generar las secciones CSV
        let fullCsv = '';
        
        // Secci贸n 1: rboles
        fullCsv += convertToCSV(arboles, 'REGISTRO DE RBOLES');

        // Secci贸n 2: Sensores
        fullCsv += convertToCSV(sensores, 'DATOS DE SENSORES');
        
        // Secci贸n 3: Eventos
        fullCsv += convertToCSV(eventos, 'EVENTOS DISPONIBLES');

        // 3. Crear el BLOB y forzar la descarga
        const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.setAttribute('download', `Reporte_Completo_Gobierno_${new Date().toISOString().slice(0, 10)}.csv`);
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        
        alert("Reporte completo exportado exitosamente.");

    } catch (error) {
        console.error('Error al exportar el reporte completo:', error);
        alert('Fallo al generar el reporte: ' + error.message);
    }
}

    function logout() {
        localStorage.clear();
        alert("Has cerrado sesi贸n.");
        window.location.replace("login.html");
    }
    window.logout = logout; 

    // Inicializar todo al cargar el documento (L贸gica principal)
    document.addEventListener('DOMContentLoaded', async () => {
          initializeCharts(); 
          cargarHistoricoArboles();
          // Nota: La variable 'isAllowed' no est谩 definida en el c贸digo que me proporcion贸. 
          // Si es una variable de protecci贸n de ruta, debe definirla al principio o
          // reemplazar 'if (isAllowed)' con la l贸gica de verificaci贸n de rol.
          // Asumo que se usa para iniciar el mapa y Firebase.

          // Asignar la funci贸n al bot贸n
          const exportBtn = document.getElementById('exportReportBtn');
          if (exportBtn) {
            // Aseg煤rate de usar la nueva funci贸n
              exportBtn.addEventListener('click', exportarReporteCompleto); 
          }
          

          

          const isAllowed = true; 

          if (isAllowed) { 
            initializeMap();
            const firebaseReady = await initializeFirebase();
            if (firebaseReady) {
                loadSensorData();
            }
            

            // NUEVO: Listeners para Gesti贸n de Eventos

            // Mostrar/Ocultar lista de eventos
            document.getElementById('showEventosBtn')?.addEventListener('click', () => {
                const section = document.getElementById('eventoManagementSection');
                const isVisible = section.style.display === 'block';
                section.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    loadEventos(); // Cargar la lista al mostrar
                }
            });
            
             // Mostrar modal de creaci贸n
                document.getElementById('createEventoBtn')?.addEventListener('click', () => {
                    document.getElementById('createEventoModal').style.display = 'flex';
                });
                
                // Cerrar modal
                document.getElementById('closeEventoModal')?.addEventListener('click', () => {
                    document.getElementById('createEventoModal').style.display = 'none';
                    document.getElementById('createEventoForm').reset();
                });
                
                // Enviar formulario de creaci贸n
                document.getElementById('createEventoForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const data = {
                        titulo: document.getElementById('eventoTitulo').value,
                        descripcion: document.getElementById('eventoDescripcion').value,
                        fecha: document.getElementById('eventoFecha').value,
                        hora: document.getElementById('eventoHora').value,
                        ubicacion: document.getElementById('eventoUbicacion').value,
                        activo: document.getElementById('eventoActivo').checked
                    };

                    try {
                        const headers = getAuthHeaders();
                        if (!headers['Authorization']) { throw new Error("Fallo de Autenticaci贸n."); }

                        const response = await fetch(`${API_URL}/admin/eventos`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(data)
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            alert(`Error al crear evento: ${result.mensaje}`);
                            return;
                        }
                        
                        alert('Evento creado exitosamente.');
                        document.getElementById('createEventoModal').style.display = 'none';
                        document.getElementById('createEventoForm').reset();
                        
                        // Si la secci贸n de eventos est谩 visible, recargar la lista
                        if (document.getElementById('eventoManagementSection').style.display === 'block') {
                            loadEventos();
                        }
                        
                    } catch (error) {
                        console.error('Error creating evento:', error);
                        alert('Error al crear evento. Revise la consola y la conexi贸n de la API.');
                    }
                });
             }
        });
</script>
</body>
</html>
